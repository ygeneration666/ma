var MauticVars={};var mQuery=jQuery.noConflict(true);window.jQuery=mQuery;MauticVars.activeRequests=0;mQuery.ajaxSetup({beforeSend:function(request,settings){if(settings.showLoadingBar){mQuery('.loading-bar').addClass('active');MauticVars.activeRequests++;}
if(typeof IdleTimer!='undefined'){var userLastActive=IdleTimer.getLastActive();var queryGlue=(settings.url.indexOf("?")==-1)?'?':'&';settings.url=settings.url+queryGlue+'mauticUserLastActive='+userLastActive;}
if(mQuery('#mauticLastNotificationId').length){var queryGlue=(settings.url.indexOf("?")==-1)?'?':'&';settings.url=settings.url+queryGlue+'mauticLastNotificationId='+mQuery('#mauticLastNotificationId').val();}
return true;},cache:false});mQuery(document).ajaxStop(function(event){MauticVars.activeRequests=0;Mautic.stopPageLoadingBar();});mQuery(document).ready(function(){if(typeof mauticContent!=='undefined'){mQuery("html").Core({console:false});}
if(typeof IdleTimer!='undefined'){IdleTimer.init({idleTimeout:60000,awayTimeout:900000,statusChangeUrl:mauticAjaxUrl+'?action=updateUserStatus'});}
mQuery(document).on('keydown',function(e){if(e.which===8&&!mQuery(e.target).is("input:not([readonly]):not([type=radio]):not([type=checkbox]), textarea, [contentEditable], [contentEditable=true]")){e.preventDefault();}});});MauticVars.manualStateChange=true;if(typeof History!='undefined'){History.Adapter.bind(window,'statechange',function(){if(MauticVars.manualStateChange==true){window.location.reload();}
MauticVars.manualStateChange=true;});}
if(typeof Chart!='undefined'){Chart.defaults.global.responsive=true;Chart.defaults.global.maintainAspectRatio=false;}
MauticVars.liveCache=new Array();MauticVars.lastSearchStr="";MauticVars.globalLivecache=new Array();MauticVars.lastGlobalSearchStr="";MauticVars.iconClasses={};MauticVars.routeInProgress='';MauticVars.moderatedIntervals={};MauticVars.intervalsInProgress={};var Mautic={loadedContent:{},bindGlobalKeyboardShortcuts:function(){Mousetrap.bind('shift+d',function(e){mQuery('#mautic_dashboard_index').click();});Mousetrap.bind('shift+l',function(e){mQuery('#menu_lead_parent_child > li:first > a').click();});Mousetrap.bind('shift+right',function(e){mQuery('.navbar-right > button.navbar-toggle').click();});Mousetrap.bind('shift+n',function(e){mQuery('.dropdown-notification').click();});Mousetrap.bind('shift+s',function(e){mQuery('#globalSearchContainer .search-button').click();});},setupBrowserNotifier:function(){notify.requestPermission();notify.config({autoClose:10000});Mautic.browserNotifier={isSupported:notify.isSupported,permissionLevel:notify.permissionLevel()};Mautic.browserNotifier.isSupported=notify.isSupported;Mautic.browserNotifier.permissionLevel=notify.permissionLevel();Mautic.browserNotifier.createNotification=function(title,options){return notify.createNotification(title,options);}},stopPageLoadingBar:function(){if(MauticVars.activeRequests<1){MauticVars.activeRequests=0;}else{MauticVars.activeRequests--;}
if(MauticVars.loadingBarTimeout){clearTimeout(MauticVars.loadingBarTimeout);}
if(MauticVars.activeRequests==0){mQuery('.loading-bar').removeClass('active');}},startPageLoadingBar:function(){mQuery('.loading-bar').addClass('active');MauticVars.activeRequests++;},startCanvasLoadingBar:function(){mQuery('.canvas-loading-bar').addClass('active');},startModalLoadingBar:function(modalTarget){mQuery(modalTarget+' .modal-loading-bar').addClass('active');},stopCanvasLoadingBar:function(){mQuery('.canvas-loading-bar').removeClass('active');},stopModalLoadingBar:function(modalTarget){mQuery(modalTarget+' .modal-loading-bar').removeClass('active');},activateLabelLoadingIndicator:function(el){var labelSpinner=mQuery("label[for='"+el+"']");Mautic.labelSpinner=mQuery('<i class="fa fa-fw fa-spinner fa-spin"></i>');labelSpinner.append(Mautic.labelSpinner);},removeLabelLoadingIndicator:function(){mQuery(Mautic.labelSpinner).remove();;},onPageLoad:function(container,response,inModal){mQuery(container+" a[data-toggle='ajax']").off('click.ajax');mQuery(container+" a[data-toggle='ajax']").on('click.ajax',function(event){event.preventDefault();return Mautic.ajaxifyLink(this,event);});mQuery(".sidebar-left a[data-toggle='ajax']").on('click.ajax',function(event){mQuery("html").removeClass('sidebar-open-ltr');});mQuery('.sidebar-right a[data-toggle="ajax"]').on('click.ajax',function(event){mQuery("html").removeClass('sidebar-open-rtl');});mQuery(container+" form[data-toggle='ajax']").each(function(index){Mautic.ajaxifyForm(mQuery(this).attr('name'));});mQuery(container+" *[data-toggle='ajaxmodal']").off('click.ajaxmodal');mQuery(container+" *[data-toggle='ajaxmodal']").on('click.ajaxmodal',function(event){event.preventDefault();Mautic.ajaxifyModal(this,event);});mQuery(container+" *[data-toggle='livesearch']").each(function(index){Mautic.activateLiveSearch(mQuery(this),"lastSearchStr","liveCache");});mQuery(container+" *[data-toggle='listfilter']").each(function(index){Mautic.activateListFilterSelect(mQuery(this));});mQuery(container+" *[data-toggle='tooltip']").tooltip({html:true,container:'body'});mQuery(container+" *[data-toggle='sortablelist']").each(function(index){var prefix=mQuery(this).attr('data-prefix');if(mQuery('#'+prefix+'_additem').length){mQuery('#'+prefix+'_additem').click(function(){var count=mQuery('#'+prefix+'_itemcount').val();var prototype=mQuery('#'+prefix+'_additem').attr('data-prototype');prototype=prototype.replace(/__name__/g,count);mQuery(prototype).appendTo(mQuery('#'+prefix+'_list div.list-sortable'));mQuery('#'+prefix+'_list_'+count).focus();count++;mQuery('#'+prefix+'_itemcount').val(count);return false;});}
mQuery('#'+prefix+'_list div.list-sortable').sortable({items:'div.sortable',handle:'span.postaddon',axis:'y',containment:'#'+prefix+'_list',stop:function(i){var order=0;mQuery('#'+prefix+'_list div.list-sortable div.input-group input').each(function(){var name=mQuery(this).attr('name');name=name.replace(/\[list\]\[(.+)\]$/g,'')+'[list]['+order+']';mQuery(this).attr('name',name);order++;});}});});mQuery(container+" a[data-toggle='download']").off('click.download');mQuery(container+" a[data-toggle='download']").on('click.download',function(event){event.preventDefault();var link=mQuery(this).attr('href');var iframe=mQuery("<iframe/>").attr({src:link,style:"visibility:hidden;display:none"}).appendTo(mQuery('body'));});mQuery(container+" a[data-toggle='confirmation']").off('click.confirmation');mQuery(container+" a[data-toggle='confirmation']").on('click.confirmation',function(event){event.preventDefault();MauticVars.ignoreIconSpin=true;return Mautic.showConfirmation(this);});mQuery(container+" *[data-toggle='datetime']").each(function(){Mautic.activateDateTimeInputs(this,'datetime');});mQuery(container+" *[data-toggle='date']").each(function(){Mautic.activateDateTimeInputs(this,'date');});mQuery(container+" *[data-toggle='time']").each(function(){Mautic.activateDateTimeInputs(this,'time');});mQuery(container+" input[data-toggle='color']").each(function(){Mautic.activateColorPicker(this);});mQuery(container+" select").not('.multiselect, .not-chosen').each(function(){Mautic.activateChosenSelect(this);});mQuery(container+" select.multiselect").each(function(){Mautic.activateMultiSelect(this);});mQuery(container+" .nav-tabs[data-toggle='tab-hash']").each(function(){var hash=document.location.hash;var prefix='tab-';if(hash){var hashPieces=hash.split('?');hash=hashPieces[0].replace("#","#"+prefix);var activeTab=mQuery(this).find('a[href='+hash+']').first();if(mQuery(activeTab).length){mQuery('.nav-tabs li').removeClass('active');mQuery('.tab-pane').removeClass('in active');mQuery(activeTab).parent().addClass('active');mQuery(hash).addClass('in active');}}
mQuery(this).find('a').on('shown.bs.tab',function(e){window.location.hash=e.target.hash.replace("#"+prefix,"#");});});mQuery(container+' .btn:not(.btn-nospin)').on('click.spinningicons',function(event){Mautic.startIconSpinOnEvent(event);});if(mQuery(container+" .bottom-form-buttons").length){if(inModal){if(mQuery(container+' .modal-form-buttons').length){mQuery(container+' .bottom-form-buttons').addClass('hide');var buttons=mQuery(container+" .bottom-form-buttons").html();mQuery(container+' .modal-form-buttons').html('');mQuery(buttons).filter("button").each(function(i,v){var id=mQuery(this).attr('id');var button=mQuery("<button type='button' />").addClass(mQuery(this).attr('class')).addClass('btn-copy').html(mQuery(this).html()).appendTo(container+' .modal-form-buttons').on('click.ajaxform',function(event){if(mQuery(this).hasClass('disabled')){return false;}
if(!mQuery(this).hasClass('btn-dnd')){mQuery(this).parent().find('button').prop('disabled',true);}
event.preventDefault();Mautic.startIconSpinOnEvent(event);mQuery('#'+id).click();});});}}else{mQuery('.toolbar-action-buttons').addClass('hide');if(mQuery('.toolbar-form-buttons').hasClass('hide')){mQuery(container+' .bottom-form-buttons').addClass('hide');var buttons=mQuery(container+" .bottom-form-buttons").html();mQuery(container+' .toolbar-form-buttons .toolbar-standard').html('');mQuery(container+' .toolbar-form-buttons .toolbar-dropdown .drop-menu').html('');var lastIndex=mQuery(buttons).filter("button").length-1;mQuery(buttons).filter("button").each(function(i,v){var id=mQuery(this).attr('id');var buttonClick=function(event){event.preventDefault();if(!mQuery(this).hasClass('btn-dnd')){mQuery(this).parent().find('button').prop('disabled',true);}
Mautic.startIconSpinOnEvent(event);mQuery('#'+id).click();};mQuery("<button type='button' />").addClass(mQuery(this).attr('class')).addClass('btn-copy').attr('id',mQuery(this).attr('id')+'_toolbar').html(mQuery(this).html()).on('click.ajaxform',buttonClick).appendTo('.toolbar-form-buttons .toolbar-standard');if(i===lastIndex){mQuery(".toolbar-form-buttons .toolbar-dropdown .btn-main").off('.ajaxform').attr('id',mQuery(this).attr('id')+'_toolbar_mobile').html(mQuery(this).html()).on('click.ajaxform',buttonClick);}else{mQuery("<a />").attr('id',mQuery(this).attr('id')+'_toolbar_mobile').html(mQuery(this).html()).on('click.ajaxform',buttonClick).appendTo(mQuery('<li />').prependTo('.toolbar-form-buttons .toolbar-dropdown .dropdown-menu'))}});mQuery('.toolbar-form-buttons').removeClass('hide');}}}
mQuery.each(['editor','editor-basic','editor-advanced','editor-advanced-2rows','editor-fullpage','editor-basic-fullpage'],function(index,editorClass){if(mQuery(container+' textarea.'+editorClass).length){mQuery(container+' textarea.'+editorClass).each(function(){var settings={};if(editorClass!='editor'){var toolbar=editorClass.replace('editor-','').replace('-','_');settings.toolbar=toolbar;}
if(editorClass!='editor'&&editorClass!='editor-basic'){settings.allowedContent=true;}
if(editorClass=='editor-fullpage'||editorClass=='editor-basic-fullpage'){settings.fullPage=true;settings.extraPlugins="sourcedialog,docprops,filemanager";}
if(editorClass=='editor'){settings.removePlugins='resize';}
if(mQuery(this).hasClass('editor-builder-tokens')){if(settings.extraPlugins){settings.extraPlugins=settings.extraPlugins+',tokens';}else{settings.extraPlugins='tokens';}}
settings.on=Mautic.getGlobalEditorEvents();mQuery(this).ckeditor(settings);});}});if(mQuery('.shuffle-grid').length){var grid=mQuery(".shuffle-grid");setTimeout(function(){grid.shuffle({itemSelector:".shuffle",sizer:false});mQuery("html").on("fa.sidebar.minimize",function(){grid.shuffle("update");}).on("fa.sidebar.maximize",function(){grid.shuffle("update");});if(grid.parents('.tab-pane').length){var tabId=grid.parents('.tab-pane').first().attr('id');var tab=mQuery('a[href="#'+tabId+'"]').on('shown.bs.tab',function(){grid.shuffle("update");});}},1000);}
if(mQuery('.dropdown-menu-form').length){mQuery('.dropdown-menu-form').on('click',function(e){e.stopPropagation();});}
var contentSpecific=false;if(response&&response.mauticContent){contentSpecific=response.mauticContent;}else if(container=='body'){contentSpecific=mauticContent;}
if(container=='#app-content'||container=='body'){Mautic.bindGlobalKeyboardShortcuts();Mautic.setupBrowserNotifier();}
if(contentSpecific&&typeof Mautic[contentSpecific+"OnLoad"]=='function'){if(typeof Mautic[contentSpecific+"OnLoad"]=='function'){if(typeof Mautic.loadedContent[contentSpecific]=='undefined'){Mautic.loadedContent[contentSpecific]=true;Mautic[contentSpecific+"OnLoad"](container,response);}}}
if(!inModal&&container=='body'){mQuery('#notificationsDropdown').on('click',function(e){if(mQuery(e.target).hasClass('do-not-close')){e.stopPropagation();}});if(mQuery('#globalSearchContainer').length){mQuery('#globalSearchContainer .search-button').click(function(){mQuery('#globalSearchContainer').addClass('active');if(mQuery('#globalSearchInput').val()){mQuery('#globalSearchDropdown').addClass('open');}
setTimeout(function(){mQuery('#globalSearchInput').focus();},100);mQuery('body').on('click.globalsearch',function(event){var target=event.target;if(!mQuery(target).parents('#globalSearchContainer').length&&!mQuery(target).parents('#globalSearchDropdown').length){Mautic.closeGlobalSearchResults();}});});mQuery("#globalSearchInput").on('change keyup paste',function(){if(mQuery(this).val()){mQuery('#globalSearchDropdown').addClass('open');}else{mQuery('#globalSearchDropdown').removeClass('open');}});Mautic.activateLiveSearch("#globalSearchInput","lastGlobalSearchStr","globalLivecache");}}
mQuery('.plugin-sparkline').sparkline('html',{enableTagOptions:true});Mautic.stopIconSpinPostEvent();if((response&&typeof response.stopPageLoading!='undefined'&&response.stopPageLoading)||container=='#app-content'||container=='.page-list'){Mautic.stopPageLoadingBar();}},activateChosenSelect:function(el){var noResultsText=mQuery(el).data('no-results-text');if(!noResultsText){noResultsText=mauticLang['chosenNoResults'];}
mQuery(el).chosen({placeholder_text_multiple:mauticLang['chosenChooseMore'],placeholder_text_single:mauticLang['chosenChooseOne'],no_results_text:noResultsText,width:"100%",allow_single_deselect:true,include_group_label_in_selected:true,search_contains:true});},activateMultiSelect:function(el){var moveOption=function(v,prev){var theOption=mQuery(el).find('option[value="'+v+'"]').first();var lastSelected=mQuery(el).find('option:not(:disabled)').filter(function(){return mQuery(this).prop('selected');}).last();if(typeof prev!=='undefined'){if(prev){var prevOption=mQuery(el).find('option[value="'+prev+'"]').first();theOption.insertAfter(prevOption);return;}}else if(lastSelected.length){theOption.insertAfter(lastSelected);return;}
theOption.prependTo(el);};mQuery(el).multiSelect({afterInit:function(container){var funcName=mQuery(el).data('afterInit');if(funcName){Mautic[funcName]('init',container);}
var selectThat=this,$selectableSearch=this.$selectableUl.prev(),$selectionSearch=this.$selectionUl.prev(),selectableSearchString='#'+this.$container.attr('id')+' .ms-elem-selectable:not(.ms-selected)',selectionSearchString='#'+this.$container.attr('id')+' .ms-elem-selection.ms-selected';this.qs1=$selectableSearch.quicksearch(selectableSearchString).on('keydown',function(e){if(e.which===40){selectThat.$selectableUl.focus();return false;}});this.qs2=$selectionSearch.quicksearch(selectionSearchString).on('keydown',function(e){if(e.which==40){selectThat.$selectionUl.focus();return false;}});var selectOrder=mQuery(el).data('order');if(selectOrder&&selectOrder.length>1){this.deselect_all();mQuery.each(selectOrder,function(k,v){selectThat.select(v);});}
var isSortable=mQuery(el).data('sortable');if(isSortable){mQuery(el).parent('.choice-wrapper').find('.ms-selection').first().sortable({items:'.ms-elem-selection',helper:function(e,ui){ui.width(mQuery(el).width());return ui;},axis:'y',scroll:false,update:function(event,ui){var prev=ui.item.prev();var prevValue=(prev.length)?prev.data('ms-value'):'';moveOption(ui.item.data('ms-value'),prevValue);}});}},afterSelect:function(value){var funcName=mQuery(el).data('afterSelect');if(funcName){Mautic[funcName]('select',value);}
this.qs1.cache();this.qs2.cache();moveOption(value);},afterDeselect:function(value){var funcName=mQuery(el).data('afterDeselect');if(funcName){Mautic[funcName]('deselect',value);}
this.qs1.cache();this.qs2.cache();},selectableHeader:"<input type='text' class='ms-search form-control' autocomplete='off'>",selectionHeader:"<input type='text' class='ms-search form-control' autocomplete='off'>",keepOrder:true});},activateDateTimeInputs:function(el,type){if(typeof type=='undefined'){type='datetime';}
var format=mQuery(el).data('format');if(type=='datetime'){mQuery(el).datetimepicker({format:(format)?format:'Y-m-d H:i',lazyInit:true,validateOnBlur:false,allowBlank:true,scrollInput:false});}else if(type=='date'){mQuery(el).datetimepicker({timepicker:false,format:(format)?format:'Y-m-d',lazyInit:true,validateOnBlur:false,allowBlank:true,scrollInput:false,closeOnDateSelect:true});}else if(type=='time'){mQuery(el).datetimepicker({datepicker:false,format:(format)?format:'H:i',lazyInit:true,validateOnBlur:false,allowBlank:true,scrollInput:false});}
mQuery(el).addClass('calendar-activated');},closeGlobalSearchResults:function(){mQuery('#globalSearchContainer').removeClass('active');mQuery('#globalSearchDropdown').removeClass('open');mQuery('body').off('click.globalsearch');},getGlobalEditorEvents:function(){return{contentDom:function(event){var editable=event.editor.editable();var doc=(editable.isInline())?'#'+event.editor.name:mQuery(event.editor.window.getFrame().$).contents();var tokens=mQuery(doc).find('*[data-token]');tokens.each(function(i){mQuery(this).off('dblclick').on('dblclick',function(e){var selEl=new CKEDITOR.dom.element(e.target);var rangeObjForSelection=new CKEDITOR.dom.range(event.editor.document);rangeObjForSelection.selectNodeContents(selEl);event.editor.getSelection().selectRanges([rangeObjForSelection]);mQuery(e.target).prop('contenteditable',true);});});CKEDITOR.instances[event.editor.name].on('key',function(e){var key=e.data.keyCode;if(key!==8){var tokens=mQuery(doc).find('*[data-token][contenteditable=\'true\']');tokens.each(function(i){mQuery(this).prop('contenteditable',false);});}});editable.attachListener(editable,'click',function(e){var tokens=mQuery(doc).find('*[data-token][contenteditable=\'true\']');tokens.each(function(i){mQuery(this).prop('contenteditable',false);});});}}},onPageUnload:function(container,response){if(typeof container!='undefined'){mQuery(container+" *[data-toggle='tooltip']").tooltip('destroy');if(typeof MauticVars.modalsReset=='undefined'){MauticVars.modalsReset={};}
mQuery.each(['editor','editor-basic','editor-advanced','editor-advanced-2rows','editor-fullpage'],function(index,editorClass){mQuery(container+' textarea.'+editorClass).each(function(){for(var name in CKEDITOR.instances){var instance=CKEDITOR.instances[name];if(this&&this==instance.element.$){instance.destroy(true);}}});});mQuery('html').off('fa.sidebar.minimize').off('fa.sidebar.maximize');mQuery(container+" input[data-toggle='color']").each(function(){mQuery(this).minicolors('destroy');});}
var contentSpecific=false;if(container=='#app-content'){Mousetrap.reset();contentSpecific=mauticContent;}else if(response&&response.mauticContent){contentSpecific=response.mauticContent;}
if(contentSpecific){if(typeof Mautic[contentSpecific+"OnUnload"]=='function'){Mautic[contentSpecific+"OnUnload"](container,response);}
if(typeof(Mautic.loadedContent[contentSpecific])){delete Mautic.loadedContent[contentSpecific];}}},loadContent:function(route,link,method,target,showPageLoading,callback,data){if(typeof Mautic.loadContentXhr=='undefined'){Mautic.loadContentXhr={};}else if(typeof Mautic.loadContentXhr[target]!='undefined'){Mautic.loadContentXhr[target].abort();}
showPageLoading=(typeof showPageLoading=='undefined'||showPageLoading)?true:false;Mautic.loadContentXhr[target]=mQuery.ajax({showLoadingBar:showPageLoading,url:route,type:method,dataType:"json",data:data,success:function(response){if(response){response.stopPageLoading=showPageLoading;if(response.callback){window["Mautic"][response.callback].apply('window',[response]);return;}
if(response.redirect){Mautic.redirectWithBackdrop(response.redirect);}else if(target||response.target){if(target)response.target=target;Mautic.processPageContent(response);}else{MauticVars.liveCache=new Array();MauticVars.lastSearchStr='';if(typeof response.route==='undefined'){response.route=route;}
if(typeof response.activeLink==='undefined'&&link){response.activeLink=link;}
Mautic.processPageContent(response);}
Mautic.stopIconSpinPostEvent();}
MauticVars.routeInProgress='';},error:function(request,textStatus,errorThrown){Mautic.processAjaxError(request,textStatus,errorThrown,true);MauticVars.routeInProgress='';Mautic.stopIconSpinPostEvent();Mautic.stopPageLoadingBar();},complete:function(){if(typeof callback!=='undefined'){if(typeof callback=='function'){callback();}else{window["Mautic"][callback].apply('window',[]);}}
delete Mautic.loadContentXhr[target];}});return false;},loadScript:function(url,onLoadCallback,alreadyLoadedCallback){if(typeof Mautic.headLoadedAssets=='undefined'){Mautic.headLoadedAssets={};}else if(typeof Mautic.headLoadedAssets[url]!='undefined'){if(alreadyLoadedCallback&&typeof Mautic[alreadyLoadedCallback]=='function'){Mautic[alreadyLoadedCallback]();}
return;}
Mautic.headLoadedAssets[url]=1;mQuery.getScript(url,function(data,textStatus,jqxhr){if(textStatus=='success'){if(onLoadCallback&&typeof Mautic[onLoadCallback]=='function'){Mautic[onLoadCallback]();}else if(typeof Mautic[mauticContent+"OnLoad"]=='function'){if(typeof Mautic.loadedContent[mauticContent]=='undefined'){Mautic.loadedContent[mauticContent]=true;Mautic[mauticContent+"OnLoad"]('#app-content',{});}}}});},loadStylesheet:function(url){if(typeof Mautic.headLoadedAssets=='undefined'){Mautic.headLoadedAssets={};}else if(typeof Mautic.headLoadedAssets[url]!='undefined'){return;}
Mautic.headLoadedAssets[url]=1;var link=document.createElement("link");link.type="text/css";link.rel="stylesheet";link.href=url;mQuery('head').append(link);},startIconSpinOnEvent:function(target){if(MauticVars.ignoreIconSpin){MauticVars.ignoreIconSpin=false;return;}
if(typeof target=='object'&&typeof(target.target)!=='undefined'){target=target.target;}
if(mQuery(target).length){var hasBtn=mQuery(target).hasClass('btn');var hasIcon=mQuery(target).hasClass('fa');var i=(hasBtn&&mQuery(target).find('i.fa').length)?mQuery(target).find('i.fa'):target;if((hasBtn&&mQuery(target).find('i.fa').length)||hasIcon){var el=(hasIcon)?target:mQuery(target).find('i.fa').first();var identifierClass=(new Date).getTime();MauticVars.iconClasses[identifierClass]=mQuery(el).attr('class');var specialClasses=['fa-fw','fa-lg','fa-2x','fa-3x','fa-4x','fa-5x','fa-li'];var appendClasses="";for(var i=0;i<specialClasses.length;i++){if(mQuery(el).hasClass(specialClasses[i])){appendClasses+=" "+specialClasses[i];}}
mQuery(el).removeClass();mQuery(el).addClass('fa fa-spinner fa-spin '+identifierClass+appendClasses);}}},stopIconSpinPostEvent:function(specificId){if(typeof specificId!='undefined'&&specificId in MauticVars.iconClasses){mQuery('.'+specificId).removeClass('fa fa-spinner fa-spin '+specificId).addClass(MauticVars.iconClasses[specificId]);delete MauticVars.iconClasses[specificId];}else{mQuery.each(MauticVars.iconClasses,function(index,value){mQuery('.'+index).removeClass('fa fa-spinner fa-spin '+index).addClass(value);});MauticVars.iconClasses={};}},redirectWithBackdrop:function(url){Mautic.activateBackdrop();setTimeout(function(){window.location=url;},50);},activateBackdrop:function(hideWait){if(!mQuery('#mautic-backdrop').length){var container=mQuery('<div />',{id:'mautic-backdrop'});mQuery('<div />',{'class':'modal-backdrop fade in'}).appendTo(container);if(typeof hideWait=='undefined'){mQuery('<div />',{"class":'mautic-pleasewait'}).html(mauticLang.pleaseWait).appendTo(container);}
container.appendTo('body');}},deactivateBackgroup:function(){if(mQuery('#mautic-backdrop').length){mQuery('#mautic-backdrop').remove();}},postForm:function(form,callback){var form=mQuery(form);var modalParent=form.closest('.modal');var inMain=mQuery(modalParent).length>0?false:true;var action=form.attr('action');if(!inMain){var modalTarget='#'+mQuery(modalParent).attr('id');Mautic.startModalLoadingBar(modalTarget);}
var showLoading=(!inMain||form.attr('data-hide-loadingbar'))?false:true;form.ajaxSubmit({showLoadingBar:showLoading,success:function(data){if(!inMain){Mautic.stopModalLoadingBar(modalTarget);}
if(data.redirect){Mautic.redirectWithBackdrop(data.redirect);}else{MauticVars.formSubmitInProgress=false;if(!inMain){var modalId=mQuery(modalParent).attr('id');}
if(data.sessionExpired){if(!inMain){mQuery('#'+modalId).modal('hide');mQuery('.modal-backdrop').remove();}
Mautic.processPageContent(data);}else if(callback){data.inMain=inMain;if(!inMain){data.modalId=modalId;}
if(typeof callback=='function'){callback(data);}else if(typeof Mautic[callback]=='function'){Mautic[callback](data);}}}},error:function(request,textStatus,errorThrown){MauticVars.formSubmitInProgress=false;Mautic.processAjaxError(request,textStatus,errorThrown,inMain);}});},processPageContent:function(response){if(response){Mautic.deactivateBackgroup();if(!response.target){response.target='#app-content';}
Mautic.onPageUnload(response.target,response);if(response.newContent){if(response.replaceContent&&response.replaceContent=='true'){mQuery(response.target).replaceWith(response.newContent);}else{mQuery(response.target).html(response.newContent);}}
if(response.flashes){Mautic.setFlashes(response.flashes);}
if(response.notifications){Mautic.setNotifications(response.notifications);}
if(response.browserNotifications){Mautic.setBrowserNotifications(response.browserNotifications);}
if(response.route){MauticVars.manualStateChange=false;History.pushState(null,"Mautic",response.route);}
if(response.target=='#app-content'){if(response.mauticContent){mauticContent=response.mauticContent;}
if(response.activeLink){var link=response.activeLink;if(link!==undefined&&link.charAt(0)!='#'){link="#"+link;}
var parent=mQuery(link).parent();mQuery(".nav-sidebar").find(".active").removeClass("active");parent.addClass("active");var openParent=parent.closest('li.open');mQuery(".nav-sidebar").find(".open").each(function(){if(!openParent.hasClass('open')||(openParent.hasClass('open')&&openParent[0]!==mQuery(this)[0])){mQuery(this).removeClass('open');}});}
mQuery('body').animate({scrollTop:0},0);}else{var overflow=mQuery(response.target).css('overflow');var overflowY=mQuery(response.target).css('overflowY');if(overflow=='auto'||overflow=='scroll'||overflowY=='auto'||overflowY=='scroll'){mQuery(response.target).animate({scrollTop:0},0);}}
if(response.overlayEnabled){mQuery(response.overlayTarget+' .content-overlay').remove();}
Mautic.onPageLoad(response.target,response);}},ajaxifyForm:function(formName){var form='form[name="'+formName+'"]';mQuery(form+' input, '+form+' select').off('keydown.ajaxform');mQuery(form+' input, '+form+' select').on('keydown.ajaxform',function(e){if(e.keyCode==13&&(e.metaKey||e.ctrlKey)){if(MauticVars.formSubmitInProgress){return false;}
var saveButton=mQuery(form).find('button.btn-save');var applyButton=mQuery(form).find('button.btn-apply');var modalParent=mQuery(form).closest('.modal');var inMain=mQuery(modalParent).length>0?false:true;if(mQuery(saveButton).length){if(inMain){if(mQuery(form).find('button.btn-save.btn-copy').length){mQuery(mQuery(form).find('button.btn-save.btn-copy')).trigger('click');return;}}else{if(mQuery(modalParent).find('button.btn-save.btn-copy').length){mQuery(mQuery(modalParent).find('button.btn-save.btn-copy')).trigger('click');return;}}
mQuery(saveButton).trigger('click');}else if(mQuery(applyButton).length){if(inMain){if(mQuery(form).find('button.btn-apply.btn-copy').length){mQuery(mQuery(form).find('button.btn-apply.btn-copy')).trigger('click');return;}}else{if(mQuery(modalParent).find('button.btn-apply.btn-copy').length){mQuery(mQuery(modalParent).find('button.btn-apply.btn-copy')).trigger('click');return;}}
mQuery(applyButton).trigger('click');}}else if(e.keyCode==13&&mQuery(e.target).is(':input')){var inputs=mQuery(this).parents('form').eq(0).find(':input');if(inputs[inputs.index(this)+1]!=null){inputs[inputs.index(this)+1].focus();}
e.preventDefault();return false;}});mQuery(form+' :submit').each(function(){mQuery(this).off('click.ajaxform');mQuery(this).on('click.ajaxform',function(){if(mQuery(this).attr('name')&&!mQuery("input[name='"+mQuery(this).attr('name')+"']").length){mQuery('form[name="'+formName+'"]').append(mQuery("<input type='hidden'>").attr({name:mQuery(this).attr('name'),value:mQuery(this).attr('value')}));}});});mQuery(form).off('submit.ajaxform');mQuery(form).on('submit.ajaxform',(function(e){e.preventDefault();if(MauticVars.formSubmitInProgress){return false;}else{var callback=mQuery(this).data('submit-callback');if(callback&&typeof Mautic[callback]=='function'){if(!Mautic[callback]()){return false;}}
MauticVars.formSubmitInProgress=true;}
Mautic.postForm(mQuery(this),function(response){if(response.inMain){Mautic.processPageContent(response);}else{Mautic.processModalContent(response,'#'+response.modalId);}});return false;}));},ajaxifyLink:function(el,event){if(mQuery(el).hasClass('disabled')){return false;}
var route=mQuery(el).attr('href');if(route.indexOf('javascript')>=0||MauticVars.routeInProgress===route){return false;}
if(event.ctrlKey||event.metaKey){route=route.split("?")[0];window.open(route,'_blank');return;}
if(mQuery(".form-exit-unlock-id").length){if(mQuery(el).attr('data-ignore-formexit')!='true'){var unlockParameter=(mQuery('.form-exit-unlock-parameter').length)?mQuery('.form-exit-unlock-parameter').val():'';Mautic.unlockEntity(mQuery('.form-exit-unlock-model').val(),mQuery('.form-exit-unlock-id').val(),unlockParameter);}}
var link=mQuery(el).attr('data-menu-link');if(link!==undefined&&link.charAt(0)!='#'){link="#"+link;}
var method=mQuery(el).attr('data-method');if(!method){method='GET'}
MauticVars.routeInProgress=route;var target=mQuery(el).attr('data-target');if(!target){target=null;}
var showLoadingBar=(mQuery(el).attr('data-hide-loadingbar'))?false:true;if(mQuery('#globalSearchContainer').length&&mQuery('#globalSearchContainer').hasClass('active')){Mautic.closeGlobalSearchResults();}
Mautic.loadContent(route,link,method,target,showLoadingBar);},ajaxifyModal:function(el,event){if(mQuery(el).hasClass('disabled')){return false;}
var target=mQuery(el).attr('data-target');var route=mQuery(el).attr('href');if(route.indexOf('javascript')>=0){return false;}
mQuery('body').addClass('noscroll');var method=mQuery(el).attr('data-method');if(!method){method='GET'}
var header=mQuery(el).attr('data-header');var footer=mQuery(el).attr('data-footer');Mautic.loadAjaxModal(target,route,method,header,footer);},loadAjaxModal:function(target,route,method,header,footer){if(mQuery(target+' .loading-placeholder').length){mQuery(target+' .loading-placeholder').removeClass('hide');mQuery(target+' .modal-body-content').addClass('hide');if(mQuery(target+' .modal-loading-bar').length){mQuery(target+' .modal-loading-bar').addClass('active');}}
if(footer=='false'){mQuery(target+" .modal-footer").addClass('hide');}
mQuery(target).on('show.bs.modal',function(){if(header){mQuery(target+" .modal-title").html(header);}
if(footer&&footer!='false'){mQuery(target+" .modal-footer").html(header);}});mQuery(target).on('hidden.bs.modal',function(){mQuery('body').removeClass('noscroll');Mautic.onPageUnload(target);Mautic.resetModal(target);if(typeof Mautic.modalContentXhr[target]!='undefined'){Mautic.modalContentXhr[target].abort();delete Mautic.modalContentXhr[target];}});mQuery(target).modal('show');if(typeof Mautic.modalContentXhr=='undefined'){Mautic.modalContentXhr={};}else if(typeof Mautic.modalContentXhr[target]!='undefined'){Mautic.modalContentXhr[target].abort();}
Mautic.modalContentXhr[target]=mQuery.ajax({url:route,type:method,dataType:"json",success:function(response){if(response){Mautic.processModalContent(response,target);}
Mautic.stopIconSpinPostEvent();},error:function(request,textStatus,errorThrown){Mautic.processAjaxError(request,textStatus,errorThrown);Mautic.stopIconSpinPostEvent();},complete:function(){Mautic.stopModalLoadingBar(target);delete Mautic.modalContentXhr[target];}});},resetModal:function(target){if(mQuery(target).hasClass('in')){return;}
mQuery(target+" .modal-title").html('');mQuery(target+" .modal-body-content").html('');if(mQuery(target+" loading-placeholder").length){mQuery(target+" loading-placeholder").removeClass('hide');}
if(mQuery(target+" .modal-footer").length){var hasFooterButtons=mQuery(target+" .modal-footer .modal-form-buttons").length;mQuery(target+" .modal-footer").html('');if(hasFooterButtons){mQuery('<div class="modal-form-buttons" />').appendTo(target+" .modal-footer");}
mQuery(target+" .modal-footer").removeClass('hide');}},processModalContent:function(response,target){if(response.error){Mautic.stopIconSpinPostEvent();alert(response.error);return;}
if(response.sessionExpired||(response.closeModal&&response.newContent)){mQuery(target).modal('hide');mQuery('body').removeClass('modal-open');mQuery('.modal-backdrop').remove();Mautic.processPageContent(response);}else{if(response.flashes){Mautic.setFlashes(response.flashes);}
if(response.notifications){Mautic.setNotifications(response.notifications);}
if(response.browserNotifications){Mautic.setBrowserNotifications(response.browserNotifications);}
if(response.callback){window["Mautic"][response.callback].apply('window',[response]);return;}
if(response.closeModal){mQuery('body').removeClass('noscroll');mQuery(target).modal('hide');Mautic.onPageUnload(target,response);if(response.mauticContent){if(typeof Mautic[response.mauticContent+"OnLoad"]=='function'){if(typeof Mautic.loadedContent[response.mauticContent]=='undefined'){Mautic.loadedContent[response.mauticContent]=true;Mautic[response.mauticContent+"OnLoad"](target,response);}}}}else if(response.target){mQuery(response.target).html(response.newContent);Mautic.onPageLoad(response.target,response,true);}else{if(mQuery(target+' .loading-placeholder').length){mQuery(target+' .loading-placeholder').addClass('hide');mQuery(target+' .modal-body-content').html(response.newContent);mQuery(target+' .modal-body-content').removeClass('hide');}else{mQuery(target+' .modal-body').html(response.newContent);}
Mautic.onPageLoad(target,response,true);}}},showConfirmation:function(el){var precheck=mQuery(el).data('precheck');if(precheck){if(typeof precheck=='function'){if(!precheck()){return;}}else if(typeof Mautic[precheck]=='function'){if(!Mautic[precheck]()){return;}}}
var message=mQuery(el).data('message');var confirmText=mQuery(el).data('confirm-text');var confirmAction=mQuery(el).attr('href');var confirmCallback=mQuery(el).data('confirm-callback');var cancelText=mQuery(el).data('cancel-text');var cancelCallback=mQuery(el).data('cancel-callback');var confirmContainer=mQuery("<div />").attr({"class":"modal fade confirmation-modal"});var confirmDialogDiv=mQuery("<div />").attr({"class":"modal-dialog"});var confirmContentDiv=mQuery("<div />").attr({"class":"modal-content"});var confirmFooterDiv=mQuery("<div />").attr({"class":"modal-body text-center"});var confirmHeaderDiv=mQuery("<div />").attr({"class":"modal-header"});confirmHeaderDiv.append(mQuery('<h4 />').attr({"class":"modal-title"}).text(message));var confirmButton=mQuery('<button type="button" />').addClass("btn btn-danger").css("marginRight","5px").css("marginLeft","5px").click(function(){if(typeof Mautic[confirmCallback]==="function"){window["Mautic"][confirmCallback].apply('window',[confirmAction,el]);}}).html(confirmText);if(cancelText){var cancelButton=mQuery('<button type="button" />').addClass("btn btn-primary").click(function(){if(cancelCallback&&typeof Mautic[cancelCallback]==="function"){window["Mautic"][cancelCallback].apply('window',[]);}else{Mautic.dismissConfirmation();}}).html(cancelText);}
if(typeof cancelButton!='undefined'){confirmFooterDiv.append(cancelButton);}
confirmFooterDiv.append(confirmButton);confirmContentDiv.append(confirmHeaderDiv);confirmContentDiv.append(confirmFooterDiv);confirmContainer.append(confirmDialogDiv.append(confirmContentDiv));mQuery('body').append(confirmContainer);mQuery('.confirmation-modal').on('hidden.bs.modal',function(){mQuery(this).remove();});mQuery('.confirmation-modal').modal('show');},dismissConfirmation:function(){if(mQuery('.confirmation-modal').length){mQuery('.confirmation-modal').modal('hide');}},reorderTableData:function(name,orderby,tmpl,target,baseUrl){if(typeof baseUrl=='undefined'){baseUrl=window.location.pathname;}
if(baseUrl.indexOf('tmpl')==-1){baseUrl=baseUrl+"?tmpl="+tmpl}
var route=baseUrl+"&name="+name+"&orderby="+encodeURIComponent(orderby);Mautic.loadContent(route,'','POST',target);},filterTableData:function(name,filterby,filterValue,tmpl,target,baseUrl){if(typeof baseUrl=='undefined'){baseUrl=window.location.pathname;}
if(baseUrl.indexOf('tmpl')==-1){baseUrl=baseUrl+"?tmpl="+tmpl}
var route=baseUrl+"&name="+name+"&filterby="+encodeURIComponent(filterby)+"&value="+encodeURIComponent(filterValue)
Mautic.loadContent(route,'','POST',target);},limitTableData:function(name,limit,tmpl,target,baseUrl){if(typeof baseUrl=='undefined'){baseUrl=window.location.pathname;}
if(baseUrl.indexOf('tmpl')==-1){baseUrl=baseUrl+"?tmpl="+tmpl}
var route=baseUrl+"&name="+name+"&limit="+limit;Mautic.loadContent(route,'','POST',target);},executeAction:function(action){if(typeof Mautic.activeActions=='undefined'){Mautic.activeActions={};}else if(typeof Mautic.activeActions[action]!='undefined'){return;}
Mautic.activeActions[action]=true;Mautic.dismissConfirmation();mQuery.ajax({showLoadingBar:true,url:action,type:"POST",dataType:"json",success:function(response){Mautic.processPageContent(response);},error:function(request,textStatus,errorThrown){Mautic.processAjaxError(request,textStatus,errorThrown);},complete:function(){delete Mautic.activeActions[action]}});},executeBatchAction:function(action,el){if(typeof Mautic.activeActions=='undefined'){Mautic.activeActions={};}else if(typeof Mautic.activeActions[action]!='undefined'){return;}
var items=Mautic.getCheckedListIds(el,true);var queryGlue=action.indexOf('?')>=0?'&':'?';var action=action+queryGlue+'ids='+items;Mautic.executeAction(action);},getCheckedListIds:function(el,stringify){var checkboxes='input[class=list-checkbox]:checked';if(typeof el!='undefined'&&el){var target=mQuery(el).data('target');if(target){checkboxes=target+' '+checkboxes;}}
var items=mQuery(checkboxes).map(function(){return mQuery(this).val();}).get();if(stringify){items=JSON.stringify(items);}
return items;},batchActionPrecheck:function(){return mQuery('input[class=list-checkbox]:checked').length;},activateSearchAutocomplete:function(elId,modelName){if(mQuery('#'+elId).length){var livesearch=(mQuery('#'+elId).attr("data-toggle=['livesearch']"))?true:false;var typeaheadObject=Mautic.activateTypeahead('#'+elId,{prefetch:true,remote:false,limit:0,action:'commandList&model='+modelName,multiple:true});mQuery(typeaheadObject).on('typeahead:selected',function(event,datum){if(livesearch){MauticVars.lastSearchStr='';mQuery('#'+elId).keyup();}}).on('typeahead:autocompleted',function(event,datum){if(livesearch){MauticVars.lastSearchStr='';mQuery('#'+elId).keyup();}});}},activateLiveSearch:function(el,searchStrVar,liveCacheVar){if(!mQuery(el).length){return;}
var btn="button[data-livesearch-parent='"+mQuery(el).attr('id')+"']";mQuery(el).on('focus',function(){Mautic.currentSearchString=mQuery(this).val().trim();});mQuery(el).on('change keyup paste',{},function(event){var searchStr=mQuery(el).val().trim();var spaceKeyPressed=(event.which==32||event.keyCode==32);var enterKeyPressed=(event.which==13||event.keyCode==13);var deleteKeyPressed=(event.which==8||event.keyCode==8);if(!enterKeyPressed&&Mautic.currentSearchString&&Mautic.currentSearchString==searchStr){return;}
var target=mQuery(el).attr('data-target');var diff=searchStr.length-MauticVars[searchStrVar].length;if(diff<0){diff=parseInt(diff)*-1;}
var overlayEnabled=mQuery(el).attr('data-overlay');if(!overlayEnabled||overlayEnabled=='false'){overlayEnabled=false;}else{overlayEnabled=true;}
var overlayTarget=mQuery(el).attr('data-overlay-target');if(!overlayTarget)overlayTarget=target;if(overlayEnabled){mQuery(el).off('blur.livesearchOverlay');mQuery(el).on('blur.livesearchOverlay',function(){mQuery(overlayTarget+' .content-overlay').remove();});}
if(!deleteKeyPressed&&overlayEnabled){var overlay=mQuery('<div />',{"class":"content-overlay"}).html(mQuery(el).attr('data-overlay-text'));if(mQuery(el).attr('data-overlay-background')){overlay.css('background',mQuery(el).attr('data-overlay-background'));}
if(mQuery(el).attr('data-overlay-color')){overlay.css('color',mQuery(el).attr('data-overlay-color'));}}
if((!searchStr&&MauticVars[searchStrVar].length)||diff>=3||spaceKeyPressed||enterKeyPressed){MauticVars[searchStrVar]=searchStr;event.data.livesearch=true;Mautic.filterList(event,mQuery(el).attr('id'),mQuery(el).attr('data-action'),target,liveCacheVar,overlayEnabled,overlayTarget);}else if(overlayEnabled){if(!mQuery(overlayTarget+' .content-overlay').length){mQuery(overlayTarget).prepend(overlay);}}});if(mQuery(btn).length){mQuery(btn).on('click',{'parent':mQuery(el).attr('id')},function(event){var searchStr=mQuery(el).val().trim();MauticVars[searchStrVar]=searchStr;Mautic.filterButtonClicked=true;Mautic.filterList(event,event.data.parent,mQuery('#'+event.data.parent).attr('data-action'),mQuery('#'+event.data.parent).attr('data-target'),'liveCache',mQuery(this).attr('data-livesearch-action'));});if(mQuery(el).val()){mQuery(btn).attr('data-livesearch-action','clear');mQuery(btn+' i').removeClass('fa-search').addClass('fa-eraser');}else{mQuery(btn).attr('data-livesearch-action','search');mQuery(btn+' i').removeClass('fa-eraser').addClass('fa-search');}}},filterList:function(e,elId,route,target,liveCacheVar,action,overlayEnabled,overlayTarget){if(typeof liveCacheVar=='undefined'){liveCacheVar="liveCache";}
var el=mQuery('#'+elId);if(el.length&&(e.data.livesearch||mQuery(e.target).prop('tagName')=='BUTTON'||mQuery(e.target).parent().prop('tagName')=='BUTTON')){var value=el.val().trim();if(!value){action='clear';}else if(action=='clear'){el.val('');el.typeahead('val','');value='';}
if(false&&value&&value in MauticVars[liveCacheVar]){var response={"newContent":MauticVars[liveCacheVar][value]};response.target=target;response.overlayEnabled=overlayEnabled;response.overlayTarget=overlayTarget;Mautic.processPageContent(response);}else{var searchName=el.attr('name');if(searchName=='undefined'){searchName='search';}
if(typeof Mautic.liveSearchXhr!=='undefined'){Mautic['liveSearchXhr'].abort();}
var btn="button[data-livesearch-parent='"+elId+"']";if(mQuery(btn).length&&!mQuery(btn).hasClass('btn-nospin')&&!Mautic.filterButtonClicked){Mautic.startIconSpinOnEvent(btn);}
var tmpl=mQuery('#'+elId).data('tmpl');if(!tmpl){tmpl='list';}
var tmplParam=(route.indexOf('tmpl')==-1)?'&tmpl='+tmpl:'';var checkInModalTarget=(overlayTarget)?overlayTarget:target;var modalParent=mQuery(checkInModalTarget).closest('.modal');var inModal=mQuery(modalParent).length>0;if(inModal){var modalTarget='#'+mQuery(modalParent).attr('id');Mautic.startModalLoadingBar(modalTarget);}
var showLoading=(inModal)?false:true;Mautic.liveSearchXhr=mQuery.ajax({showLoadingBar:showLoading,url:route,type:"GET",data:searchName+"="+encodeURIComponent(value)+tmplParam,dataType:"json",success:function(response){if(response.newContent){MauticVars[liveCacheVar][value]=response.newContent;}
response.target=target;response.overlayEnabled=overlayEnabled;response.overlayTarget=overlayTarget;if(mQuery(btn).length){if(action=='clear'){mQuery(btn).attr('data-livesearch-action','search');mQuery(btn).children('i').first().removeClass('fa-eraser').addClass('fa-search');}else{mQuery(btn).attr('data-livesearch-action','clear');mQuery(btn).children('i').first().removeClass('fa-search').addClass('fa-eraser');}}
if(inModal){Mautic.processModalContent(response);Mautic.stopModalLoadingBar(modalTarget);}else{Mautic.processPageContent(response);Mautic.stopPageLoadingBar();}},error:function(request,textStatus,errorThrown){Mautic.processAjaxError(request,textStatus,errorThrown);if(mQuery(btn).length){if(action=='clear'){mQuery(btn).attr('data-livesearch-action','search');mQuery(btn).children('i').first().removeClass('fa-eraser').addClass('fa-search');}else{mQuery(btn).attr('data-livesearch-action','clear');mQuery(btn).children('i').first().removeClass('fa-search').addClass('fa-eraser');}}},complete:function(){delete Mautic.liveSearchXhr;delete Mautic.filterButtonClicked;}});}}},activateListFilterSelect:function(el){var filterName=mQuery(el).attr('name');var isMultiple=mQuery(el).attr('multiple')?true:false;var prefixExceptions=mQuery(el).data('prefix-exceptions');if(isMultiple&&prefixExceptions){if(typeof Mautic.listFilterValues=='undefined'){Mautic.listFilterValues={};}
Mautic.listFilterValues[filterName]=mQuery(el).val();}
mQuery(el).on('change',function(){var filterVal=mQuery(this).val();if(filterVal==null){filterVal=[];}
if(prefixExceptions){var limited=prefixExceptions.split(',');if(filterVal.length>1){for(var i=0;i<filterVal.length;i++){if(mQuery.inArray(filterVal[i],Mautic.listFilterValues[filterName])==-1){var newOption=mQuery(this).find('option[value="'+filterVal[i]+'"]');var prefix=mQuery(newOption).parent().data('prefix');if(mQuery.inArray(prefix,limited)!=-1){mQuery(newOption).siblings().prop('selected',false);filterVal=mQuery(this).val();mQuery(this).trigger('chosen:updated');}}}}
Mautic.listFilterValues[filterName]=filterVal;}
var tmpl=mQuery(this).data('tmpl');if(!tmpl){tmpl='list';}
var filters=(isMultiple)?JSON.stringify(filterVal):filterVal;var request=window.location.pathname+'?tmpl='+tmpl+'&'+filterName+'='+filters;Mautic.loadContent(request,'','POST',mQuery(this).data('target'));});},removeFormListOption:function(el){var sortableDiv=mQuery(el).parents('div.sortable');var inputCount=mQuery(sortableDiv).parents('div.form-group').find('input.sortable-itemcount');var count=mQuery(inputCount).val();count--;mQuery(inputCount).val(count);mQuery(sortableDiv).remove();},togglePublishStatus:function(event,el,model,id,extra,backdrop){event.preventDefault();var wasPublished=mQuery(el).hasClass('fa-toggle-on');mQuery(el).removeClass('fa-toggle-on fa-toggle-off').addClass('fa-spin fa-spinner');mQuery(el).tooltip('destroy');MauticVars.liveCache=new Array();if(backdrop){Mautic.activateBackdrop();}
if(extra){extra='&'+extra;}
mQuery(el).tooltip('destroy');mQuery.ajax({url:mauticAjaxUrl,type:"POST",data:"action=togglePublishStatus&model="+model+'&id='+id+extra,dataType:"json",success:function(response){if(response.reload){Mautic.redirectWithBackdrop(window.location);}else if(response.statusHtml){mQuery(el).replaceWith(response.statusHtml);mQuery(el).tooltip({html:true,container:'body'});}},error:function(request,textStatus,errorThrown){var addClass=(wasPublished)?'fa-toggle-on':'fa-toggle-off';mQuery(el).removeClass('fa-spin fa-spinner').addClass(addClass);Mautic.processAjaxError(request,textStatus,errorThrown);}});},toggleYesNoButtonClass:function(changedId){changedId='#'+changedId;var isYesButton=mQuery(changedId).parent().hasClass('btn-yes');var otherButton=isYesButton?'.btn-no':'.btn-yes';var otherLabel=mQuery(changedId).parent().parent().find(otherButton);if(mQuery(changedId).prop('checked')){var thisRemove='btn-default',otherAdd='btn-default';if(isYesButton){var thisAdd='btn-success',otherRemove='btn-danger';}else{var thisAdd='btn-danger',otherRemove='btn-success';}}else{var thisAdd='btn-default';if(isYesButton){var thisAdd='btn-success',otherRemove='btn-danger';}else{var thisAdd='btn-danger',otherRemove='btn-success';}}
mQuery(changedId).parent().removeClass(thisRemove).addClass(thisAdd);mQuery(otherLabel).removeClass(otherRemove).addClass(otherAdd);},setSearchFilter:function(el,searchId,string){if(typeof searchId=='undefined')
searchId='#list-search';else
searchId='#'+searchId;if(string){var current=string;}else{var filter=mQuery(el).val();var current=mQuery('#list-search').typeahead('val')+" "+filter;}
mQuery(searchId).typeahead('val',current);var e=mQuery.Event("keypress",{which:13});e.data={};e.data.livesearch=true;Mautic.filterList(e,'list-search',mQuery(searchId).attr('data-action'),mQuery(searchId).attr('data-target'),'liveCache');},unlockEntity:function(model,id,parameter){mQuery.ajax({url:mauticAjaxUrl,type:"POST",data:"action=unlockEntity&model="+model+"&id="+id+"&parameter="+parameter,dataType:"json"});},processAjaxError:function(request,textStatus,errorThrown,mainContent){if(textStatus=='abort'){Mautic.stopPageLoadingBar();Mautic.stopCanvasLoadingBar();Mautic.stopIconSpinPostEvent();return;}
var inDevMode=typeof mauticEnv!=='undefined'&&mauticEnv=='dev';if(inDevMode){console.log(request);}
if(typeof request.responseJSON!=='undefined'){response=request.responseJSON;}else{var errorStart=request.responseText.indexOf('{"newContent');var jsonString=request.responseText.slice(errorStart);if(jsonString){try{var response=mQuery.parseJSON(jsonString);if(inDevMode){console.log(response);}}catch(err){if(inDevMode){console.log(err);}}}else{response={};}}
if(response){if(response.newContent&&mainContent){mQuery('#app-content .content-body').html(response.newContent);if(response.route&&response.route.indexOf("ajax")==-1){MauticVars.manualStateChange=false;History.pushState(null,"Mautic",response.route);}}else if(response.newContent&&mQuery('.modal.in').length){mQuery('.modal.in .modal-body-content').html(response.newContent);mQuery('.modal.in .modal-body-content').removeClass('hide');if(mQuery('.modal.in  .loading-placeholder').length){mQuery('.modal.in  .loading-placeholder').addClass('hide');}}else if(inDevMode){if(response.error){var error=response.error.code+': '+errorThrown+'; '+response.error.exception;alert(error);}}}
Mautic.stopPageLoadingBar();Mautic.stopCanvasLoadingBar();Mautic.stopIconSpinPostEvent();},emulateNoDataForPieChart:function(data){var dataEmpty=true;mQuery.each(data,function(i,part){if(part.value){dataEmpty=false;}});if(dataEmpty){data=[{value:1,color:"#efeeec",highlight:"#EBEBEB",label:"No data"}];}
return data;},setModeratedInterval:function(key,callback,timeout,params){if(typeof MauticVars.intervalsInProgress[key]!='undefined'){clearTimeout(MauticVars.moderatedIntervals[key]);}else{MauticVars.intervalsInProgress[key]=true;if(typeof params=='undefined'){params=[];}
if(typeof callback=='function'){callback(params);}else{window["Mautic"][callback].apply('window',params);}}
MauticVars.moderatedIntervals[key]=setTimeout(function(){Mautic.setModeratedInterval(key,callback,timeout,params)},timeout);},moderatedIntervalCallbackIsComplete:function(key){delete MauticVars.intervalsInProgress[key];},clearModeratedInterval:function(key){Mautic.moderatedIntervalCallbackIsComplete(key);clearTimeout(MauticVars.moderatedIntervals[key]);delete MauticVars.moderatedIntervals[key];},setFlashes:function(flashes){mQuery('#flashes').append(flashes);mQuery('#flashes .alert-new').each(function(){var me=this;window.setTimeout(function(){mQuery(me).fadeTo(500,0).slideUp(500,function(){mQuery(this).remove();});},4000);mQuery(this).removeClass('alert-new');});},setBrowserNotifications:function(notifications){mQuery.each(notifications,function(key,notification){Mautic.browserNotifier.createNotification(notification.title,{body:notification.message,icon:notification.icon});});},setNotifications:function(notifications){if(notifications.lastId){mQuery('#mauticLastNotificationId').val(notifications.lastId);}
if(mQuery('#notifications .mautic-update')){mQuery('#notifications .mautic-update').remove();}
if(notifications.hasNewNotifications){if(mQuery('#newNotificationIndicator').hasClass('hide')){mQuery('#newNotificationIndicator').removeClass('hide');}}
if(notifications.content){mQuery('#notifications').prepend(notifications.content);if(!mQuery('#notificationMautibot').hasClass('hide')){mQuery('#notificationMautibot').addClass('hide');}}
if(notifications.sound){mQuery('.playSound').remove();mQuery.playSound(notifications.sound);}},markNotificationsRead:function(){mQuery("#notificationsDropdown").unbind('hide.bs.dropdown');mQuery('#notificationsDropdown').on('hidden.bs.dropdown',function(){if(!mQuery('#newNotificationIndicator').hasClass('hide')){mQuery('#notifications .is-unread').remove();mQuery('#newNotificationIndicator').addClass('hide');mQuery.ajax({url:mauticAjaxUrl,type:"GET",data:"action=markNotificationsRead"});}});},clearNotification:function(id){if(id){mQuery("#notification"+id).fadeTo("fast",0.01).slideUp("fast",function(){mQuery(this).find("*[data-toggle='tooltip']").tooltip('destroy');mQuery(this).remove();if(!mQuery('#notifications .notification').length){if(mQuery('#notificationMautibot').hasClass('hide')){mQuery('#notificationMautibot').removeClass('hide');}}});}else{mQuery("#notifications .notification").fadeOut(300,function(){mQuery(this).remove();if(mQuery('#notificationMautibot').hasClass('hide')){mQuery('#notificationMautibot').removeClass('hide');}});}
mQuery.ajax({url:mauticAjaxUrl,type:"GET",data:"action=clearNotification&id="+id});},activateColorPicker:function(el){var pickerOptions=mQuery(el).data('color-options');if(!pickerOptions){pickerOptions={theme:'bootstrap'};}
mQuery(el).minicolors(pickerOptions);},activateTypeahead:function(el,options){if(typeof options=='undefined'||!mQuery(el).length){return;}
if(typeof options.remote=='undefined'){options.remote=(options.action)?true:false;}
if(typeof options.prefetch=='undefined'){options.prefetch=false;}
if(typeof options.limit=='undefined'){options.limit=5;}
if(!options.displayKey){options.displayKey='value';}
if(typeof options.multiple=='undefined'){options.multiple=false;}
if(typeof options.minLength=='undefined'){options.minLength=2;}
if(options.prefetch||options.remote){if(typeof options.action=='undefined'){return;}
var sourceOptions={datumTokenizer:Bloodhound.tokenizers.obj.whitespace(options.displayKey),queryTokenizer:Bloodhound.tokenizers.whitespace,dupDetector:function(remoteMatch,localMatch){return(remoteMatch[options.displayKey]==localMatch[options.displayKey]);},ttl:15000,limit:options.limit};var filterClosure=function(list){if(typeof list.ignore_wdt!='undefined'){delete list.ignore_wdt;}
if(typeof list.success!='undefined'){delete list.success;}
if(typeof list=='object'){if(typeof list[0]!='undefined'){list=mQuery.map(list,function(el){return el;});}else{list=[];}}
return list;};if(options.remote){sourceOptions.remote={url:mauticAjaxUrl+"?action="+options.action+"&filter=%QUERY",filter:filterClosure};}
if(options.prefetch){sourceOptions.prefetch={url:mauticAjaxUrl+"?action="+options.action,filter:filterClosure};}
var theBloodhound=new Bloodhound(sourceOptions);theBloodhound.initialize();}else{var substringMatcher=function(strs,strKeys){return function findMatches(q,cb){var matches,substrRegex;matches=[];substrRegex=new RegExp(q,'i');mQuery.each(strs,function(i,str){if(typeof str=='object'){str=str[options.displayKey];}
if(substrRegex.test(str)){var match={};match[options.displayKey]=str;if(strKeys.length&&typeof strKeys[i]!='undefined'){match['id']=strKeys[i];}
matches.push(match);}});cb(matches);};};var lookupOptions=(options.dataOptions)?options.dataOptions:mQuery(el).data('options');var lookupKeys=(options.dataOptionKeys)?options.dataOptionKeys:[];if(!lookupOptions){return;}}
var theName=el.replace(/[^a-z0-9\s]/gi,'').replace(/[-\s]/g,'_');var theTypeahead=mQuery(el).typeahead({hint:true,highlight:true,minLength:options.minLength,multiple:options.multiple},{name:theName,displayKey:options.displayKey,source:(typeof theBloodhound!='undefined')?theBloodhound.ttAdapter():substringMatcher(lookupOptions,lookupKeys)}).on('keypress',function(event){if((event.keyCode||event.which)==13){mQuery(el).typeahead('close');}}).on('focus',function(){if(mQuery(el).typeahead('val')===''&&!options.minLength){mQuery(el).data('ttTypeahead').input.trigger('queryChanged','');}});return theTypeahead;},ajaxActionRequest:function(action,data,successClosure,showLoadingBar){if(typeof Mautic.ajaxActionXhr=='undefined'){Mautic.ajaxActionXhr={};}else if(typeof Mautic.ajaxActionXhr[action]!='undefined'){Mautic.removeLabelLoadingIndicator();Mautic.ajaxActionXhr[action].abort();}
if(typeof showLoadingBar=='undefined'){showLoadingBar=false;}
Mautic.ajaxActionXhr[action]=mQuery.ajax({url:mauticAjaxUrl+'?action='+action,type:'POST',data:data,showLoadingBar:showLoadingBar,success:function(response){if(typeof successClosure=='function'){successClosure(response);}},error:function(request,textStatus,errorThrown){Mautic.processAjaxError(request,textStatus,errorThrown,true);},complete:function(){delete Mautic.ajaxActionXhr[action];}});},getChartData:function(element,action,query,callback){var element=mQuery(element);var wrapper=element.closest('ul');var button=mQuery('#time-scopes .button-label');wrapper.find('a').removeClass('bg-primary');element.addClass('bg-primary');button.text(element.text());query=query+'&action='+action;mQuery.ajax({showLoadingBar:true,url:mauticAjaxUrl,type:'POST',data:query,dataType:"json",success:function(response){if(response.success){Mautic.stopPageLoadingBar();if(typeof callback=='function'){callback(response);}else if(typeof window["Mautic"][callback]!=='undefined'){window["Mautic"][callback].apply('window',[response]);}}},error:function(request,textStatus,errorThrown){Mautic.processAjaxError(request,textStatus,errorThrown);}});},getEntityId:function(){return(mQuery('input#entityId').length)?mQuery('input#entityId').val():0;},closeModalAndRedirect:function(el,url){Mautic.startModalLoadingBar(el);Mautic.loadContent(url);mQuery('body').removeClass('noscroll');}};;Mautic.processUpdate=function(container,step,state){var baseUrl=mauticBasePath+'/';switch(step){case 1:mQuery.ajax({showLoadingBar:true,url:mauticAjaxUrl+'?action=core:updateSetUpdateLayout',dataType:'json',success:function(response){if(response.success){mQuery('div[id='+container+']').html(response.content);Mautic.processUpdate(container,step+1,state);}else if(response.redirect){window.location=response.redirect;}},error:function(request,textStatus,errorThrown){Mautic.processAjaxError(request,textStatus,errorThrown);}});break;case 2:mQuery.ajax({showLoadingBar:true,url:mauticAjaxUrl+'?action=core:updateDownloadPackage',dataType:'json',success:function(response){if(response.redirect){window.location=response.redirect;}else{mQuery('td[id=update-step-downloading-status]').html('<span class="hidden-xs">'+response.stepStatus+'</span>');if(response.success){mQuery('td[id=update-step-downloading-status]').append(mQuery('<i></i>').addClass('pull-right fa fa-check text-success'));mQuery('#updateTable tbody').append('<tr><td>'+response.nextStep+'</td><td id="update-step-extracting-status"><span class="hidden-xs">'+response.nextStepStatus+'</span><i class="pull-right fa fa-spinner fa-spin"></i></td></tr>');Mautic.processUpdate(container,step+1,state);}else{mQuery('td[id=update-step-downloading-status]').append(mQuery('<i></i>').addClass('pull-right fa fa-warning text-danger'));mQuery('div[id=main-update-panel]').removeClass('panel-default').addClass('panel-danger');mQuery('div#main-update-panel div.panel-body').prepend('<div class="alert alert-danger">'+response.message+'</div>');}}},error:function(request,textStatus,errorThrown){Mautic.processAjaxError(request,textStatus,errorThrown);}});break;case 3:mQuery.ajax({showLoadingBar:true,url:mauticAjaxUrl+'?action=core:updateExtractPackage',dataType:'json',success:function(response){if(response.redirect){window.location=response.redirect;}else{mQuery('td[id=update-step-extracting-status]').html('<span class="hidden-xs">'+response.stepStatus+'</span>');if(response.success){mQuery('td[id=update-step-extracting-status]').append(mQuery('<i></i>').addClass('pull-right fa fa-check text-success'));mQuery('#updateTable tbody').append('<tr><td>'+response.nextStep+'</td><td id="update-step-moving-status"><span class="hidden-xs">'+response.nextStepStatus+'</span><i class="pull-right fa fa-spinner fa-spin"></i></td></tr>');Mautic.processUpdate(container,step+1,state);}else{mQuery('td[id=update-step-extracting-status]').append(mQuery('<i></i>').addClass('pull-right fa fa-warning text-danger'));mQuery('div[id=main-update-panel]').removeClass('panel-default').addClass('panel-danger');mQuery('div#main-update-panel div.panel-body').prepend('<div class="alert alert-danger">'+response.message+'</div>');}}},error:function(request,textStatus,errorThrown){Mautic.processAjaxError(request,textStatus,errorThrown);}});break;case 4:mQuery.ajax({showLoadingBar:true,url:baseUrl+'upgrade/upgrade.php?task=moveBundles&updateState='+state,dataType:'json',success:function(response){if(response.redirect){window.location=response.redirect;}else{mQuery('td[id=update-step-moving-status]').html('<span class="hidden-xs">'+response.stepStatus+'</span>');if(response.error){mQuery('td[id=update-step-moving-status]').append(mQuery('<i></i>').addClass('pull-right fa fa-warning text-danger'));mQuery('div[id=main-update-panel]').removeClass('panel-default').addClass('panel-danger');mQuery('div#main-update-panel div.panel-body').prepend('<div class="alert alert-danger">'+response.message+'</div>');}else if(response.complete){mQuery('td[id=update-step-moving-status]').append(mQuery('<i></i>').addClass('pull-right fa fa-spinner fa-spin'));Mautic.processUpdate(container,step+1,response.updateState);}else{mQuery('td[id=update-step-moving-status]').append(mQuery('<i></i>').addClass('pull-right fa fa-spinner fa-spin'));Mautic.processUpdate(container,step,response.updateState);}}},error:function(request,textStatus,errorThrown){Mautic.processAjaxError(request,textStatus,errorThrown);}});break;case 5:mQuery.ajax({showLoadingBar:true,url:baseUrl+'upgrade/upgrade.php?task=moveCore&updateState='+state,dataType:'json',success:function(response){if(response.redirect){window.location=response.redirect;}else{mQuery('td[id=update-step-moving-status]').html('<span class="hidden-xs">'+response.stepStatus+'</span>');if(response.error){mQuery('td[id=update-step-moving-status]').append(mQuery('<i></i>').addClass('pull-right fa fa-warning text-danger'));mQuery('div[id=main-update-panel]').removeClass('panel-default').addClass('panel-danger');mQuery('div#main-update-panel div.panel-body').prepend('<div class="alert alert-danger">'+response.message+'</div>');}else if(response.complete){mQuery('td[id=update-step-moving-status]').append(mQuery('<i></i>').addClass('pull-right fa fa-spinner fa-spin'));Mautic.processUpdate(container,step+1,response.updateState);}else{mQuery('td[id=update-step-moving-status]').append(mQuery('<i></i>').addClass('pull-right fa fa-spinner fa-spin'));Mautic.processUpdate(container,step,response.updateState);}}},error:function(request,textStatus,errorThrown){Mautic.processAjaxError(request,textStatus,errorThrown);}});break;case 6:mQuery.ajax({showLoadingBar:true,url:baseUrl+'upgrade/upgrade.php?task=moveVendors&updateState='+state,dataType:'json',success:function(response){if(response.redirect){window.location=response.redirect;}else{mQuery('td[id=update-step-moving-status]').html('<span class="hidden-xs">'+response.stepStatus+'</span>');if(response.error){mQuery('td[id=update-step-moving-status]').append(mQuery('<i></i>').addClass('pull-right fa fa-warning text-danger'));mQuery('div[id=main-update-panel]').removeClass('panel-default').addClass('panel-danger');mQuery('div#main-update-panel div.panel-body').prepend('<div class="alert alert-danger">'+response.message+'</div>');}else if(response.complete){mQuery('td[id=update-step-moving-status]').append(mQuery('<i></i>').addClass('pull-right fa fa-check text-success'));mQuery('#updateTable tbody').append('<tr><td>'+response.nextStep+'</td><td id="update-step-cache-status"><span class="hidden-xs">'+response.nextStepStatus+'</span><i class="pull-right fa fa-spinner fa-spin"></i></td></tr>');Mautic.processUpdate(container,step+1,response.updateState);}else{mQuery('td[id=update-step-moving-status]').append(mQuery('<i></i>').addClass('pull-right fa fa-spinner fa-spin'));Mautic.processUpdate(container,step,response.updateState);}}},error:function(request,textStatus,errorThrown){Mautic.processAjaxError(request,textStatus,errorThrown);}});break;case 7:mQuery.ajax({showLoadingBar:true,url:baseUrl+'upgrade/upgrade.php?task=clearCache&updateState='+state,dataType:'json',success:function(response){if(response.redirect){window.location=response.redirect;}else{mQuery('td[id=update-step-cache-status]').html('<span class="hidden-xs">'+response.stepStatus+'</span>');if(response.error){mQuery('td[id=update-step-cache-status]').append(mQuery('<i></i>').addClass('pull-right fa fa-warning text-danger'));mQuery('div[id=main-update-panel]').removeClass('panel-default').addClass('panel-danger');mQuery('div#main-update-panel div.panel-body').prepend('<div class="alert alert-danger">'+response.message+'</div>');}else if(response.complete){mQuery('td[id=update-step-cache-status]').append(mQuery('<i></i>').addClass('pull-right fa fa-check text-success'));mQuery('#updateTable tbody').append('<tr><td>'+response.nextStep+'</td><td id="update-step-database-status"><span class="hidden-xs">'+response.nextStepStatus+'</span><i class="pull-right fa fa-spinner fa-spin"></i></td></tr>');Mautic.processUpdate(container,step+1,response.updateState);}else{mQuery('td[id=update-step-cache-status]').append(mQuery('<i></i>').addClass('pull-right fa fa-spinner fa-spin'));Mautic.processUpdate(container,step,response.updateState);}}},error:function(request,textStatus,errorThrown){Mautic.processAjaxError(request,textStatus,errorThrown);}});break;case 8:mQuery.ajax({showLoadingBar:true,url:mauticAjaxUrl+'?action=core:updateDatabaseMigration&finalize=1',dataType:'json',success:function(response){if(response.redirect){window.location=response.redirect;}else{mQuery('td[id=update-step-database-status]').html('<span class="hidden-xs">'+response.stepStatus+'</span>');if(response.success){mQuery('td[id=update-step-database-status]').append(mQuery('<i></i>').addClass('pull-right fa fa-check text-success'));mQuery('#updateTable tbody').append('<tr><td>'+response.nextStep+'</td><td id="update-step-finalization-status"><span class="hidden-xs">'+response.nextStepStatus+'</span><i class="pull-right fa fa-spinner fa-spin"></i></td></tr>');Mautic.processUpdate(container,step+1,state);}else{mQuery('td[id=update-step-database-status]').append(mQuery('<i></i>').addClass('pull-right fa fa-warning text-danger'));mQuery('div[id=main-update-panel]').removeClass('panel-default').addClass('panel-danger');mQuery('div#main-update-panel div.panel-body').prepend('<div class="alert alert-danger">'+response.message+'</div>');}}},error:function(request,textStatus,errorThrown){window.location=mauticBaseUrl+'/s/update/schema?update=1';}});break;case 9:mQuery.ajax({showLoadingBar:true,url:mauticAjaxUrl+'?action=core:updateFinalization',dataType:'json',success:function(response){if(response.redirect){window.location=response.redirect;}else{if(response.success){mQuery('div[id='+container+']').html('<div class="alert alert-mautic">'+response.message+'</div>');}else{mQuery('td[id=update-step-finalization-status]').html('<span class="hidden-xs">'+response.stepStatus+'</span>');mQuery('td[id=update-step-finalization-status]').append(mQuery('<i></i>').addClass('pull-right fa fa-warning text-danger'));mQuery('div[id=main-update-panel]').removeClass('panel-default').addClass('panel-danger');mQuery('div#main-update-panel div.panel-body').prepend('<div class="alert alert-danger">'+response.message+'</div>');}}},error:function(request,textStatus,errorThrown){Mautic.processAjaxError(request,textStatus,errorThrown);}});break;}
Mautic.stopPageLoadingBar();};;Mautic.launchBuilder=function(formName,actionName){Mautic.builderMode=(mQuery('#'+formName+'_template').val()=='')?'custom':'template';Mautic.builderFormName=formName;mQuery('body').css('overflow-y','hidden');mQuery('.builder').addClass('builder-active').removeClass('hide');if(typeof actionName=='undefined'){actionName=formName;}
var builderCss={margin:"0",padding:"0",border:"none",width:"100%",height:"100%"};var panelHeight=(mQuery('.builder-content').css('right')=='0px')?mQuery('.builder-panel').height():0,panelWidth=(mQuery('.builder-content').css('right')=='0px')?0:mQuery('.builder-panel').width(),spinnerLeft=(mQuery(window).width()-panelWidth-60)/2,spinnerTop=(mQuery(window).height()-panelHeight-60)/2;var overlay=mQuery('<div id="builder-overlay" class="modal-backdrop fade in"><div style="position: absolute; top:'+spinnerTop+'px; left:'+spinnerLeft+'px" class="builder-spinner"><i class="fa fa-spinner fa-spin fa-5x"></i></div></div>').css(builderCss).appendTo('.builder-content');mQuery('.btn-close-builder').prop('disabled',true);if(Mautic.builderMode=='template'){var src=mQuery('#builder_url').val();src+='?template='+mQuery('#'+formName+'_template').val();var builder=mQuery("<iframe />",{css:builderCss,id:"builder-template-content"}).attr('src',src).appendTo('.builder-content').load(function(){var contents=mQuery(this).contents();contents.find('.mautic-editable').droppable({iframeFix:true,drop:function(event,ui){var editorId=mQuery(this).attr("id");var drop=mQuery(ui.draggable).data('drop');var token=mQuery(ui.draggable).data('token');if(drop){Mautic[drop](event,ui,editorId,token);}else{Mautic.insertBuilderEditorToken(editorId,token);}
mQuery(this).removeClass('over-droppable');},over:function(e,ui){mQuery(this).addClass('over-droppable');},out:function(e,ui){mQuery(this).removeClass('over-droppable');}});Mautic.activateBuilderDragTokens();mQuery('#builder-overlay').addClass('hide');mQuery('.btn-close-builder').prop('disabled',false);});}else{mQuery('.builder-content').addClass('pr-10');var editorId='builder-custom-content';var builder=mQuery('<textarea />',{id:editorId}).appendTo('.builder-content');builder.data('token-callback',actionName+':getBuilderTokens');builder.data('token-activator','{');mQuery('#customHtmlDropzone').droppable({drop:function(event,ui){var drop=mQuery(ui.draggable).data('drop');var token=mQuery(ui.draggable).data('token');if(drop){Mautic[drop](event,ui,editorId,token);}else{Mautic.insertBuilderEditorToken(editorId,token);}
mQuery('#customHtmlDropzone').removeClass('over-droppable text-danger');mQuery('.custom-drop-message').addClass('hide');mQuery('.custom-general-message').removeClass('hide');}});builder.ckeditor(function(){CKEDITOR.instances['builder-custom-content'].resize('100%',mQuery('.builder-content').height());var data=CKEDITOR.instances[formName+'_customHtml'].getData();CKEDITOR.instances['builder-custom-content'].setData(data);mQuery('.btn-close-builder').prop('disabled',false);Mautic.activateBuilderDragTokens();mQuery('#builder-overlay').addClass('hide');},{toolbar:'fullpage',fullPage:true,extraPlugins:'sourcedialog,docprops,tokens',width:'100%',allowedContent:true});}};Mautic.activateBuilderDragTokens=function(target){if(typeof target=='undefined'){target='.builder-panel';}
if(Mautic.builderMode=='template'){var settings={iframeFix:true,iframeId:'builder-template-content',helper:'clone',appendTo:'.builder',zIndex:8000,scroll:true,scrollSensitivity:100,scrollSpeed:100,cursorAt:{top:15,left:15}}}else{var settings={helper:'clone',appendTo:'.builder',scroll:false,cursorAt:{top:15,left:15},start:function(event,ui){mQuery(ui.helper).css('max-width',mQuery(this).css('width'));mQuery(ui.helper).css('max-height',mQuery(this).css('height'));mQuery('#customHtmlDropzone').addClass('over-droppable text-danger');mQuery('.custom-drop-message').removeClass('hide');mQuery('.custom-general-message').addClass('hide');}}}
mQuery(target+" *[data-token]").draggable(settings);};Mautic.closeBuilder=function(model){var panelHeight=(mQuery('.builder-content').css('right')=='0px')?mQuery('.builder-panel').height():0,panelWidth=(mQuery('.builder-content').css('right')=='0px')?0:mQuery('.builder-panel').width(),spinnerLeft=(mQuery(window).width()-panelWidth-60)/2,spinnerTop=(mQuery(window).height()-panelHeight-60)/2;mQuery('.builder-spinner').css({left:spinnerLeft,top:spinnerTop});mQuery('#builder-overlay').removeClass('hide');mQuery('.btn-close-builder').prop('disabled',true);if(Mautic.builderMode=='template'){var editors=Mautic.getBuilderEditorInstance();var content={};var builderContents=mQuery('#builder-template-content').contents();builderContents.find('.mautic-editable').each(function(index){mQuery(this).blur();});mQuery.each(editors,function(slot,editor){slot=slot.replace("slot-","");content[slot]=editor.getData();});Mautic.saveBuilderContent(model,builderContents.find('#builder_entity_id').val(),content,function(response){if(response.success){try{builderContents.find('.mautic-editable').droppable('destroy');mQuery(".ui-draggable[data-token]").draggable('destroy');}catch(err){console.log(err);}
mQuery('#builder-overlay').remove();mQuery('.builder').removeClass('builder-active').addClass('hide');mQuery('.btn-close-builder').prop('disabled',false);mQuery('body').css('overflow-y','');Mautic.stopIconSpinPostEvent();}});mQuery('#builder-template-content').remove();}else{try{mQuery('#customHtmlDropzone').droppable('destroy');mQuery(".ui-draggable[data-token]").draggable('destroy');var data=CKEDITOR.instances['builder-custom-content'].getData();CKEDITOR.instances[Mautic.builderFormName+'_customHtml'].setData(data);CKEDITOR.instances['builder-custom-content'].destroy(true);}catch(err){console.log(err);}
mQuery('#builder-custom-content').remove();mQuery('#builder-overlay').remove();mQuery('.builder').removeClass('builder-active').addClass('hide');mQuery('.btn-close-builder').prop('disabled',false);mQuery('body').css('overflow-y','');Mautic.stopIconSpinPostEvent();}
delete Mautic.builderMode;delete Mautic.builderFormName;};Mautic.onBuilderModeSwitch=function(el){var builderMode=(mQuery(el).val()=='')?false:true;if(builderMode){mQuery('.custom-html-mask').removeClass('hide');mQuery('.template-dnd-help').removeClass('hide');mQuery('.custom-dnd-help').addClass('hide');mQuery('.template-fields').removeClass('hide');Mautic.toggleBuilderButton(false);}else{mQuery('.custom-html-mask').addClass('hide');mQuery('.template-dnd-help').addClass('hide');mQuery('.custom-dnd-help').removeClass('hide');mQuery('.template-fields').addClass('hide');Mautic.toggleBuilderButton(true);}};Mautic.toggleBuilderButton=function(hide){if(mQuery('.toolbar-form-buttons .toolbar-standard .btn-builder')){if(hide){mQuery('.toolbar-form-buttons .toolbar-standard .btn-builder').addClass('hide btn-standard-toolbar').appendTo('.toolbar-form-buttons')
mQuery('.toolbar-form-buttons .toolbar-dropdown i.fa-cube').parent().addClass('hide');}else{if(!mQuery('.btn-standard-toolbar.btn-builder').length){mQuery('.toolbar-form-buttons .toolbar-standard .btn-builder').addClass('btn-standard-toolbar')}else{mQuery('.toolbar-form-buttons .btn-standard-toolbar.btn-builder').prependTo('.toolbar-form-buttons .toolbar-standard').removeClass('hide');mQuery('.toolbar-form-buttons .toolbar-dropdown i.fa-cube').parent().removeClass('hide');}}}};Mautic.saveBuilderContent=function(model,entityId,content,callback){mQuery.ajax({url:mauticAjaxUrl+'?action='+model+':setBuilderContent',type:"POST",data:{slots:content,entity:entityId},success:function(response){if(typeof callback==="function"){callback(response);}}});};Mautic.getBuilderEditorInstance=function(id){var editors=(Mautic.builderMode=='template')?document.getElementById('builder-template-content').contentWindow.CKEDITOR.instances:CKEDITOR.instances;if(id){return editors[id];}else{return editors;}};Mautic.insertBuilderEditorToken=function(editorId,token,isHtml){var editor=Mautic.getBuilderEditorInstance(editorId);if(typeof isHtml=='undefined'){var first=token.charAt(0);if(first=='<'){isHtml=true;}}
if(isHtml){editor.insertHtml(token);}else{editor.insertText(token);}};Mautic.showBuilderLinkModal=function(event,ui,editorId){mQuery('#BuilderLinkModal input[name="link"]').val('');mQuery('#BuilderLinkModal input[name="text"]').val('');mQuery('#BuilderLinkModal input[name="text"]').parent().removeClass('hide');var token=mQuery(ui.draggable).data('token');mQuery('#BuilderLinkModal input[name="editor"]').val(editorId);mQuery('#BuilderLinkModal input[name="token"]').val(token);var defaultUrl=token.match(/%url=(.*?)%/);if(defaultUrl&&defaultUrl[1]){mQuery('#BuilderLinkModal input[name="url"]').val(defaultUrl[1]);}
var defaultText=token.match(/%text=(.*?)%/);if(defaultText&&defaultText[1]){mQuery('#BuilderLinkModal input[name="text"]').val(defaultText[1]);}else if(!token.match(/%text%/g)){mQuery('#BuilderLinkModal input[name="text"]').parent().addClass('hide');}
mQuery('#BuilderLinkModal').appendTo('body');mQuery('#BuilderLinkModal').modal('show');};Mautic.insertBuilderLink=function(){var editorId=mQuery('#BuilderLinkModal input[name="editor"]').val();var token=mQuery('#BuilderLinkModal input[name="token"]').val();var url=mQuery('#BuilderLinkModal input[name="url"]').val();var text=mQuery('#BuilderLinkModal input[name="text"]').val();if(url){if(!text){text=url;}
token=token.replace(/%url(.*?)%/,url).replace(/%text(.*?)%/,text);Mautic.insertBuilderEditorToken(editorId,token);}
mQuery('#BuilderLinkModal').modal('hide');mQuery('#BuilderLinkModal input[name="editor"]').val('');mQuery('#BuilderLinkModal input[name="url"]').val('');mQuery('#BuilderLinkModal input[name="text"]').val('');mQuery('#BuilderLinkModal input[name="text"]').parent().removeClass('hide');};Mautic.showBuilderFeedbackModal=function(event,ui,editorId){mQuery('#BuilderFeedbackModal input[name="feedback"]').val('');mQuery('#BuilderFeedbackModal input[name="feedback"]').attr('placeholder','');var token=mQuery(ui.draggable).data('token');mQuery('#BuilderFeedbackModal input[name="editor"]').val(editorId);mQuery('#BuilderFeedbackModal input[name="token"]').val(token);var placeholder=token.match(/%(.*?)%/);if(placeholder&&placeholder[1]){mQuery('#BuilderFeedbackModal input[name="feedback"]').attr('placeholder',placeholder[1]);}
mQuery('#BuilderFeedbackModal').appendTo('body');mQuery('#BuilderFeedbackModal').modal('show');};Mautic.insertBuilderFeedback=function(){var editorId=mQuery('#BuilderFeedbackModal input[name="editor"]').val();var token=mQuery('#BuilderFeedbackModal input[name="token"]').val();var feedback=mQuery('#BuilderFeedbackModal input[name="feedback"]').val();if(feedback){token=token.replace(/%(.*?)%/,feedback);Mautic.insertBuilderEditorToken(editorId,token);}
mQuery('#BuilderFeedbackModal').modal('hide');mQuery('#BuilderFeedbackModal input[name="editor"]').val('');mQuery('#BuilderFeedbackModal input[name="feedback"]').val('');mQuery('#BuilderFeedbackModal input[name="feedback"]').attr('placeholder','');};Mautic.builderOnLoad=function(target){Mautic.activateBuilderDragTokens(target);};;Mautic.clientOnLoad=function(container){if(mQuery(container+' #list-search').length){Mautic.activateSearchAutocomplete('list-search','api.client');}};Mautic.refreshApiClientForm=function(url,modeEl){var mode=mQuery(modeEl).val();if(mQuery('#client_redirectUris').length){mQuery('#client_redirectUris').prop('disabled',true);}else{mQuery('#client_callback').prop('disabled',true);}
mQuery('#client_name').prop('disabled',true);Mautic.loadContent(url+'/'+mode);};;Mautic.assetOnLoad=function(container){if(typeof Mautic.renderDownloadChartObject==='undefined'){Mautic.renderDownloadChart();}
if(typeof mauticAssetUploadEndpoint!=='undefined'&&mQuery('div#dropzone').length)
{Mautic.initializeDropzone();}};Mautic.assetOnUnload=function(id){if(id==='#app-content'){delete Mautic.renderDownloadChartObject;delete Mautic.assetDropzone;}};Mautic.renderDownloadChart=function(chartData){if(!mQuery('#download-chart').length){return;}
if(!chartData){chartData=mQuery.parseJSON(mQuery('#download-chart-data').text());}else if(chartData.stats){chartData=chartData.stats;}
var ctx=document.getElementById("download-chart").getContext("2d");var options={};if(typeof Mautic.renderDownloadChartObject==='undefined'){Mautic.renderDownloadChartObject=new Chart(ctx).Line(chartData,options);}else{Mautic.renderDownloadChartObject.destroy();Mautic.renderDownloadChartObject=new Chart(ctx).Line(chartData,options);}};Mautic.updateDownloadChart=function(element,amount,unit){var assetId=Mautic.getEntityId();var query="amount="+amount+"&unit="+unit+"&assetId="+assetId;Mautic.getChartData(element,'asset:updateDownloadChart',query,'renderDownloadChart');};Mautic.updateRemoteBrowser=function(provider,path){path=typeof path!=='undefined'?path:'';var spinner=mQuery('<i class="fa fa-fw fa-spinner fa-spin"></i>');spinner.appendTo('#tab'+provider+' a');mQuery.ajax({url:mauticAjaxUrl,type:"POST",data:"action=asset:fetchRemoteFiles&provider="+provider+"&path="+path,dataType:"json",success:function(response){if(response.success){mQuery('div#remoteFileBrowser').html(response.output);mQuery('.remote-file-search').quicksearch('#remoteFileBrowser .remote-file-list a');}else{}},error:function(request,textStatus,errorThrown){Mautic.processAjaxError(request,textStatus,errorThrown);},complete:function(){spinner.remove();}})};Mautic.selectRemoteFile=function(url){mQuery('#asset_remotePath').val(url);mQuery('#RemoteFileModal').modal('hide');};Mautic.changeAssetStorageLocation=function(){if(mQuery('#asset_storageLocation_0').prop('checked')){mQuery('#storage-local').removeClass('hide');mQuery('#storage-remote').addClass('hide');mQuery('#remote-button').addClass('hide');}else{mQuery('#storage-local').addClass('hide');mQuery('#storage-remote').removeClass('hide');mQuery('#remote-button').removeClass('hide');}};Mautic.initializeDropzone=function(){var options={url:mauticAssetUploadEndpoint,uploadMultiple:false,filesizeBase:1024,init:function(){this.on("addedfile",function(){if(this.files[1]!=null){this.removeFile(this.files[0]);}});}};if(typeof mauticAssetUploadMaxSize!=='undefined'){options.maxFilesize=mauticAssetUploadMaxSize;}
if(typeof mauticAssetUploadMaxSizeError!=='undefined'){options.dictFileTooBig=mauticAssetUploadMaxSizeError;}
if(typeof mauticAssetUploadExtensions!=='undefined'){options.acceptedFiles=mauticAssetUploadExtensions;}
if(typeof mauticAssetUploadExtensionError!=='undefined'){options.dictInvalidFileType=mauticAssetUploadExtensionError;}
Mautic.assetDropzone=new Dropzone("div#dropzone",options);var preview=mQuery('.preview div.text-center');Mautic.assetDropzone.on("sending",function(file,request,formData){formData.append('tempId',mQuery('#asset_tempId').val());}).on("addedfile",function(file){preview.fadeOut('fast');}).on("success",function(file,response,progress){if(response.tmpFileName){mQuery('#asset_tempName').val(response.tmpFileName);}
var messageArea=mQuery('.mdropzone-error');if(response.error||!response.tmpFileName){if(!response.error){var errorText='';}else{var errorText=(typeof response.error=='object')?response.error.text:response.error;}
messageArea.text(errorText);messageArea.closest('.form-group').addClass('has-error').removeClass('is-success');var node,_i,_len,_ref,_results;file.previewElement.classList.add('dz-error');_ref=file.previewElement.querySelectorAll('data-dz-errormessage');_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){node=_ref[_i];_results.push(node.textContent=errorText);}
return _results;}else{messageArea.text('');messageArea.closest('.form-group').removeClass('has-error').addClass('is-success');}
var titleInput=mQuery('#asset_title');if(file.name&&!titleInput.val()){titleInput.val(file.name);}
if(file.name){mQuery('#asset_originalFileName').val(file.name);}}).on("error",function(file,response){preview.fadeIn('fast');var messageArea=mQuery('.mdropzone-error');if(typeof response=="string"){response={'error':response};}
if(response.error){if(!response.error){var errorText='';}else{var errorText=(typeof response.error=='object')?response.error.text:response.error;}
messageArea.text(errorText);messageArea.closest('.form-group').addClass('has-error').removeClass('is-success');var node,_i,_len,_ref,_results;file.previewElement.classList.add('dz-error');_ref=file.previewElement.querySelectorAll('[data-dz-errormessage]');_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){node=_ref[_i];_results.push(node.textContent=errorText);}
return _results;}}).on("thumbnail",function(file,url){if(file.accepted===true){var extension=file.name.substr((file.name.lastIndexOf('.')+1)).toLowerCase();var previewContent='';if(mQuery.inArray(extension,['jpg','jpeg','gif','png'])!==-1){previewContent=mQuery('<img />').addClass('img-thumbnail').attr('src',url);}else if(extension==='pdf'){previewContent=mQuery('<iframe />').attr('src',url);}
preview.empty().html(previewContent);preview.fadeIn('fast');}});};Mautic.calendarOnLoad=function(container){Mautic.loadCalendarEvents(container);};Mautic.calendarModalOnLoad=function(container,response){mQuery('#calendar').fullCalendar('refetchEvents');mQuery(container+" a[data-toggle='ajax']").off('click.ajax');mQuery(container+" a[data-toggle='ajax']").on('click.ajax',function(event){event.preventDefault();mQuery('.modal').modal('hide');return Mautic.ajaxifyLink(this,event);});};Mautic.initializeCalendarModals=function(container){mQuery(container+" *[data-toggle='ajaxmodal']").off('click.ajaxmodal');mQuery(container+" *[data-toggle='ajaxmodal']").on('click.ajaxmodal',function(event){event.preventDefault();Mautic.ajaxifyModal(this,event);});}
Mautic.loadCalendarEvents=function(container){mQuery('#calendar').fullCalendar({events:mauticAjaxUrl+"?action=calendar:generateData",lang:'en',eventLimit:true,eventLimitText:"more",eventRender:function(event,element){element=mQuery(element);if(event.iconClass){element.find('.fc-title').before(mQuery('<i />').addClass(event.iconClass));}
if(event.attr){element.attr(event.attr);}
if(event.description){element.tooltip({'title':event.description});}},loading:function(bool){if(!bool){Mautic.initializeCalendarModals(container);}},eventDrop:function(event,delta,revertFunc){mQuery.ajax({url:mauticAjaxUrl+"?action=calendar:updateEvent",data:'entityId='+event.entityId+'&entityType='+event.entityType+'&setter='+event.setter+'&startDate='+event.start.format(),type:"POST",dataType:"json",success:function(response){if(!response.success){revertFunc();}
Mautic.initializeCalendarModals(container);if(response.flashes){Mautic.setFlashes(response.flashes);Mautic.hideFlashes();}},error:function(response,textStatus,errorThrown){revertFunc();Mautic.processAjaxError(response,textStatus,errorThrown,true);}});}});};Mautic.campaignOnLoad=function(container){if(mQuery(container+' #list-search').length){Mautic.activateSearchAutocomplete('list-search','campaign');}
if(mQuery('#CampaignEventPanel').length){mQuery('#CampaignCanvas').droppable({drop:function(event,ui){mQuery('#droppedX').val(ui.position.left);mQuery('#droppedY').val(ui.position.top);mQuery('#'+ui.draggable.attr('id')).click();}});mQuery('#CampaignEventPanel .list-group-item').draggable({helper:'clone',appendTo:'#CampaignCanvas',zIndex:8000,scroll:false,cursorAt:{top:15,left:15},drag:function(event,ui){if(mQuery(this).hasClass('disabled')){return false;}}});mQuery('#CampaignCanvas .list-campaign-event, .list-campaign-source').off('.eventbuttons').on('mouseover.eventbuttons',function(){mQuery(this).find('.campaign-event-buttons').removeClass('hide');}).on('mouseout.eventbuttons',function(){mQuery(this).find('.campaign-event-buttons').addClass('hide');}).on('dblclick.eventbuttons',function(event){event.preventDefault();mQuery(this).find('.btn-edit').first().click();});}
Mautic.renderCampaignViewsBarChart();Mautic.renderCampaignEmailSentPie();Mautic.renderCampaignLeadsBarChart();};Mautic.campaignOnUnload=function(container){delete Mautic.campaignBuilderInstance;delete Mautic.campaignBuilderLabels;if(container==='#app-content'){delete Mautic.campaignViewsBarChart;delete Mautic.campaignEmailSentPie;delete Mautic.campaignLeadsBarChart;}}
Mautic.campaignEventOnLoad=function(container,response){var domEventId='CampaignEvent_'+response.eventId;var eventId='#'+domEventId;Mautic.campaignBuilderLabels[domEventId]=(response.label)?response.label:'';Mautic.campaignBuilderUpdateLabel(domEventId);if(response.deleted){Mautic.campaignBuilderInstance.remove(document.getElementById(domEventId));}else if(response.updateHtml){mQuery(eventId+" .campaign-event-content").html(response.updateHtml);}else if(response.eventHtml){var newHtml=response.eventHtml;var x=mQuery('#droppedX').val();var y=mQuery('#droppedY').val();mQuery(newHtml).appendTo('#CampaignCanvas');mQuery(eventId).css({'left':x+'px','top':y+'px'});if(response.eventType=='decision'||response.eventType=='condition'){var theAnchor=Mautic.campaignBuilderTopAnchor;theAnchor[6]='top '+domEventId;Mautic.campaignBuilderInstance.addEndpoint(domEventId,{anchor:theAnchor,uuid:domEventId+"_top"},Mautic.campaignBuilderTopEndpoint);var theAnchor=Mautic.campaignBuilderYesAnchor;theAnchor[6]='yes '+domEventId;Mautic.campaignBuilderInstance.addEndpoint(domEventId,{anchor:theAnchor,uuid:domEventId+"_yes"},Mautic.campaignBuilderYesEndpoint);var theAnchor=Mautic.campaignBuilderNoAnchor;theAnchor[6]='no '+domEventId;Mautic.campaignBuilderInstance.addEndpoint(domEventId,{anchor:theAnchor,uuid:domEventId+"_no"},Mautic.campaignBuilderNoEndpoint);}else{var theAnchor=Mautic.campaignBuilderTopAnchor;theAnchor[6]='top '+domEventId;Mautic.campaignBuilderInstance.addEndpoint(domEventId,{anchor:theAnchor,uuid:domEventId+"_top"},Mautic.campaignBuilderTopEndpoint);var theAnchor=Mautic.campaignBuilderBottomAnchor;theAnchor[6]='bottom '+domEventId;Mautic.campaignBuilderInstance.addEndpoint(domEventId,{anchor:theAnchor,uuid:domEventId+"_bottom"},Mautic.campaignBuilderBottomEndpoint);}
Mautic.campaignBuilderInstance.draggable(domEventId,Mautic.campaignDragOptions);mQuery(eventId+" a[data-toggle='ajax']").click(function(event){event.preventDefault();return Mautic.ajaxifyLink(this,event);});mQuery(eventId+" a[data-toggle='ajaxmodal']").on('click.ajaxmodal',function(event){event.preventDefault();Mautic.ajaxifyModal(this,event);});mQuery(eventId).off('.eventbuttons').on('mouseover.eventbuttons',function(){mQuery(this).find('.campaign-event-buttons').removeClass('hide');}).on('mouseout.eventbuttons',function(){mQuery(this).find('.campaign-event-buttons').addClass('hide');}).on('dblclick.eventbuttons',function(event){event.preventDefault();mQuery(this).find('.btn-edit').first().click();});mQuery(eventId+" *[data-toggle='tooltip']").tooltip({html:true});}
Mautic.campaignBuilderInstance.repaintEverything();};Mautic.campaignSourceOnLoad=function(container,response){var domEventId='CampaignEvent_'+response.sourceType;var eventId='#'+domEventId;if(response.deleted){Mautic.campaignBuilderInstance.remove(document.getElementById(domEventId));mQuery('#campaignLeadSource_'+response.sourceType).removeClass('disabled');}else if(response.updateHtml){mQuery(eventId+" .campaign-event-content").html(response.updateHtml);}else if(response.sourceHtml){mQuery('#campaignLeadSource_'+response.sourceType).addClass('disabled');var newHtml=response.sourceHtml;var x=mQuery('#droppedX').val();var y=mQuery('#droppedY').val();mQuery(newHtml).appendTo('#CampaignCanvas');mQuery(eventId).css({'left':x+'px','top':y+'px'});var theAnchor=Mautic.campaignBuilderLeadSourceAnchor;theAnchor[6]='leadsource '+domEventId;Mautic.campaignBuilderInstance.addEndpoint(domEventId,{anchor:theAnchor,uuid:domEventId+"_leadsource"},Mautic.campaignBuilderLeadSourceEndpoint);Mautic.campaignBuilderInstance.draggable(domEventId,Mautic.campaignDragOptions);mQuery(eventId+" a[data-toggle='ajax']").click(function(event){event.preventDefault();return Mautic.ajaxifyLink(this,event);});mQuery(eventId+" a[data-toggle='ajaxmodal']").on('click.ajaxmodal',function(event){event.preventDefault();Mautic.ajaxifyModal(this,event);});mQuery(eventId).off('.eventbuttons').on('mouseover.eventbuttons',function(){mQuery(this).find('.campaign-event-buttons').removeClass('hide');}).on('mouseout.eventbuttons',function(){mQuery(this).find('.campaign-event-buttons').addClass('hide');}).on('dblclick.eventbuttons',function(event){event.preventDefault();mQuery(this).find('.btn-edit').first().click();});mQuery(eventId+" *[data-toggle='tooltip']").tooltip({html:true});}
Mautic.campaignBuilderInstance.repaintEverything();};Mautic.campaignBuilderUpdateLabel=function(domEventId){var theLabel=typeof Mautic.campaignBuilderLabels[domEventId]=='undefined'?'':Mautic.campaignBuilderLabels[domEventId];var currentConnections=Mautic.campaignBuilderInstance.select({target:domEventId});if(currentConnections.length>0){currentConnections.each(function(conn){var overlays=conn.getOverlays();if(overlays.length>0){for(var i=0;i<=overlays.length;i++){if(typeof overlays[i]!='undefined'&&overlays[i].type=='Label'){conn.removeOverlay(overlays[i].id);}}}
if(theLabel){conn.addOverlay(["Label",{label:theLabel,location:0.65,cssClass:"_jsPlumb_label",id:conn.sourceId+"_"+conn.targetId+"_connectionLabel"}]);}});}};Mautic.updateCampaignEventLinks=function(){var campaignType=mQuery('#campaign_type .active input').val();if(typeof campaignType=='undefined'){campaignType='interval';}
mQuery('#campaignEventList a').each(function(){var href=mQuery(this).attr('href');var newType=(campaignType=='interval')?'date':'interval';href=href.replace('campaignType='+campaignType,'campaignType='+newType);mQuery(this).attr('href',href);});};Mautic.launchCampaignEditor=function(){Mautic.stopIconSpinPostEvent();mQuery('body').css('overflow-y','hidden');mQuery('.builder').addClass('builder-active');mQuery('.builder').removeClass('hide');if(typeof Mautic.campaignBuilderInstance=='undefined'){Mautic.campaignBuilderLabels={};Mautic.campaignBuilderInstance=jsPlumb.getInstance({Container:document.querySelector("#CampaignCanvas")});Mautic.campaignBuilderInstance.bind("connection",function(info,originalEvent){Mautic.campaignBuilderUpdateLabel(info.connection.targetId);info.targetEndpoint.setPaintStyle({fillStyle:info.sourceEndpoint.getPaintStyle().fillStyle});});Mautic.campaignBuilderInstance.bind("connectionDetached",function(info,originalEvent){Mautic.campaignBuilderUpdateLabel(info.connection.targetId);info.targetEndpoint.setPaintStyle({fillStyle:"#d5d4d4"});});Mautic.campaignBuilderInstance.bind("connectionMoved",function(info,originalEvent){Mautic.campaignBuilderUpdateLabel(info.connection.originalTargetId);info.originalTargetEndpoint.setPaintStyle({fillStyle:"#d5d4d4"});Mautic.campaignBuilderUpdateLabel(info.connection.newTargetId);info.newTargetEndpoint.setPaintStyle({fillStyle:info.newSourceEndpoint.getPaintStyle().fillStyle});});var overlayOptions=[["Arrow",{width:15,length:15,location:0.5}]];var endpoint="Dot";var connector=["Bezier",{curviness:25}];var connectorStyleLineWidth=3;Mautic.campaignBuilderTopAnchor=[0.5,0,0,-1,0,0];Mautic.campaignBuilderTopEndpoint={endpoint:endpoint,paintStyle:{fillStyle:"#d5d4d4"},connector:connector,connectorOverlays:overlayOptions,maxConnections:-1,isTarget:true,beforeDrop:function(params){var loopbackConnections=Mautic.campaignBuilderInstance.select({source:params.targetId,target:params.sourceId});if(loopbackConnections.length>0){return false;}
var currentConnections=Mautic.campaignBuilderInstance.select({target:params.targetId});if(!mQuery('#'+params.sourceId).hasClass('list-campaign-leadsource')&&currentConnections.length>0){return false;}
if(currentConnections.length>0){var hasNonSourceConnection=false;currentConnections.each(function(conn){if(!mQuery('#'+conn.sourceId).hasClass('list-campaign-leadsource')){hasNonSourceConnection=true;}});if(hasNonSourceConnection){return false;}}
if(params.sourceId==params.targetId){return false;}
if(mQuery('#'+params.sourceId).hasClass('list-campaign-action')&&mQuery('#'+params.targetId).hasClass('list-campaign-action')){return false;}
if(mQuery('#'+params.sourceId).hasClass('list-campaign-decision')&&mQuery('#'+params.targetId).hasClass('list-campaign-decision')){return false;}
if(mQuery('#'+params.sourceId).hasClass('list-campaign-action')&&mQuery('#'+params.targetId).hasClass('list-campaign-condition')){return false;}
return true}};Mautic.campaignBuilderBottomAnchor=[0.5,1,0,1,0,0];Mautic.campaignBuilderBottomEndpoint={endpoint:endpoint,paintStyle:{fillStyle:"#d5d4d4"},connector:connector,connectorOverlays:overlayOptions,maxConnections:-1,isSource:true,connectorStyle:{strokeStyle:"#d5d4d4",lineWidth:connectorStyleLineWidth}};Mautic.campaignBuilderYesAnchor=[0,1,0,1,30,0];Mautic.campaignBuilderYesEndpoint={endpoint:endpoint,paintStyle:{fillStyle:"#00b49c"},connector:connector,connectorOverlays:overlayOptions,maxConnections:-1,isSource:true,connectorStyle:{strokeStyle:"#00b49c",lineWidth:connectorStyleLineWidth}};Mautic.campaignBuilderNoAnchor=[1,1,0,1,-30,0];Mautic.campaignBuilderNoEndpoint={endpoint:endpoint,paintStyle:{fillStyle:"#f86b4f"},connector:connector,connectorOverlays:overlayOptions,maxConnections:-1,isSource:true,connectorStyle:{strokeStyle:"#f86b4f",lineWidth:connectorStyleLineWidth}};Mautic.campaignBuilderLeadSourceAnchor=[0.5,1,0,1,0,0];Mautic.campaignBuilderLeadSourceEndpoint={endpoint:endpoint,paintStyle:{fillStyle:"#fdb933"},connector:connector,connectorOverlays:overlayOptions,maxConnections:-1,isSource:true,connectorStyle:{strokeStyle:"#fdb933",lineWidth:connectorStyleLineWidth}};Mautic.campaignDragOptions={start:function(event,ui){this.startingPosition=ui.position;},stop:function(event,ui){var endingPosition=ui.position;if(this.startingPosition.left!==endingPosition.left||this.startingPosition.top!==endingPosition.top){mQuery('#droppedX').val(endingPosition.top);mQuery('#droppedY').val(endingPosition.left);var campaignId=mQuery('#campaignId').val();var query="action=campaign:updateCoordinates&campaignId="+campaignId+"&droppedX="+endingPosition.top+"&droppedY="+endingPosition.left+"&eventId="+mQuery(ui.draggable).attr('id');mQuery.ajax({url:mauticAjaxUrl,type:"POST",data:query,dataType:"json",error:function(request,textStatus,errorThrown){Mautic.processAjaxError(request,textStatus,errorThrown);}});}},scroll:true,scrollSensitivity:100,scrollSpeed:15,appendTo:'#CampaignCanvas',zIndex:8000,cursorAt:{top:15,left:15}};Mautic.campaignBuilderInstance.setSuspendDrawing(true);mQuery("#CampaignCanvas .list-campaign-event").each(function(){var id=mQuery(this).attr('id');var theAnchor=Mautic.campaignBuilderTopAnchor;theAnchor[6]='top '+id;Mautic.campaignBuilderInstance.addEndpoint(id,{anchor:theAnchor,uuid:id+"_top"},Mautic.campaignBuilderTopEndpoint);});mQuery("#CampaignCanvas .list-campaign-event").not('.list-campaign-decision').not('.list-campaign-condition').each(function(){var id=mQuery(this).attr('id');var theAnchor=Mautic.campaignBuilderBottomAnchor;theAnchor[6]='bottom '+id;Mautic.campaignBuilderInstance.addEndpoint(id,{anchor:theAnchor,uuid:id+"_bottom"},Mautic.campaignBuilderBottomEndpoint);});mQuery("#CampaignCanvas .list-campaign-decision, #CampaignCanvas .list-campaign-condition").each(function(){var id=mQuery(this).attr('id');var theAnchor=Mautic.campaignBuilderYesAnchor;theAnchor[6]='yes '+id;Mautic.campaignBuilderInstance.addEndpoint(id,{anchor:theAnchor,uuid:id+"_yes"},Mautic.campaignBuilderYesEndpoint);var theAnchor=Mautic.campaignBuilderNoAnchor;theAnchor[6]='no '+id;Mautic.campaignBuilderInstance.addEndpoint(id,{anchor:theAnchor,uuid:id+"_no"},Mautic.campaignBuilderNoEndpoint);});mQuery("#CampaignCanvas .list-campaign-leadsource").each(function(){var id=mQuery(this).attr('id');var theAnchor=Mautic.campaignBuilderLeadSourceAnchor;theAnchor[6]='leadsource '+id;Mautic.campaignBuilderInstance.addEndpoint(id,{anchor:theAnchor,uuid:id+"_leadsource"},Mautic.campaignBuilderLeadSourceEndpoint);});Mautic.campaignBuilderInstance.draggable(document.querySelectorAll("#CampaignCanvas .list-campaign-event"),Mautic.campaignDragOptions);Mautic.campaignBuilderInstance.draggable(document.querySelectorAll("#CampaignCanvas .list-campaign-source"),Mautic.campaignDragOptions);Mautic.campaignBuilderReconnectEndpoints();Mautic.campaignBuilderInstance.setSuspendDrawing(false,true);mQuery('.builder-content').scroll(function(){Mautic.campaignBuilderInstance.repaintEverything();});}else{Mautic.campaignBuilderInstance.repaintEverything();}};Mautic.campaignToggleTimeframes=function(){var immediateChecked=mQuery('#campaignevent_triggerMode_0').prop('checked');var intervalChecked=mQuery('#campaignevent_triggerMode_1').prop('checked');var dateChecked=mQuery('#campaignevent_triggerMode_2').prop('checked');if(mQuery('#campaignevent_triggerInterval').length){if(immediateChecked){mQuery('#triggerInterval').addClass('hide');mQuery('#triggerDate').addClass('hide');}else if(intervalChecked){mQuery('#triggerInterval').removeClass('hide');mQuery('#triggerDate').addClass('hide');}else if(dateChecked){mQuery('#triggerInterval').addClass('hide');mQuery('#triggerDate').removeClass('hide');}}};Mautic.closeCampaignBuilder=function(){var builderCss={margin:"0",padding:"0",border:"none",width:"100%",height:"100%"};var panelHeight=(mQuery('.builder-content').css('right')=='0px')?mQuery('.builder-panel').height():0,panelWidth=(mQuery('.builder-content').css('right')=='0px')?0:mQuery('.builder-panel').width(),spinnerLeft=(mQuery(window).width()-panelWidth-60)/2,spinnerTop=(mQuery(window).height()-panelHeight-60)/2;var overlay=mQuery('<div id="builder-overlay" class="modal-backdrop fade in"><div style="position: absolute; top:'+spinnerTop+'px; left:'+spinnerLeft+'px" class=".builder-spinner"><i class="fa fa-spinner fa-spin fa-5x"></i></div></div>').css(builderCss).appendTo('.builder-content');var nodes=[];mQuery("#CampaignCanvas .list-campaign-event").each(function(idx,elem){nodes.push({id:mQuery(elem).attr('id').replace('CampaignEvent_',''),positionX:parseInt(mQuery(elem).css('left'),10),positionY:parseInt(mQuery(elem).css('top'),10)});});mQuery("#CampaignCanvas .list-campaign-source").each(function(idx,elem){nodes.push({id:mQuery(elem).attr('id').replace('CampaignEvent_',''),positionX:parseInt(mQuery(elem).css('left'),10),positionY:parseInt(mQuery(elem).css('top'),10)});});var connections=[];mQuery.each(Mautic.campaignBuilderInstance.getConnections(),function(idx,connection){connections.push({sourceId:connection.sourceId.replace('CampaignEvent_',''),targetId:connection.targetId.replace('CampaignEvent_',''),anchors:mQuery.map(connection.endpoints,function(endpoint){var parts=endpoint.anchor.cssClass.split(' ');parts[1]=parts[1].replace('CampaignEvent_','');return{'endpoint':parts[0],'eventId':parts[1]};})});});var chart={};chart.nodes=nodes;chart.connections=connections;var canvasSettings={canvasSettings:chart};var campaignId=mQuery('#campaignId').val();var query="action=campaign:updateConnections&campaignId="+campaignId;mQuery('.btn-close-builder').prop('disabled',true);mQuery.ajax({url:mauticAjaxUrl+'?'+query,type:"POST",data:canvasSettings,dataType:"json",success:function(response){mQuery('#builder-overlay').remove();mQuery('body').css('overflow-y','');if(response.success){mQuery('.builder').addClass('hide');}
mQuery('.btn-close-builder').prop('disabled',false);},error:function(request,textStatus,errorThrown){Mautic.processAjaxError(request,textStatus,errorThrown);mQuery('body').css('overflow-y','');}});};Mautic.submitCampaignEvent=function(e){e.preventDefault();mQuery('#campaignevent_canvasSettings_droppedX').val(mQuery('#droppedX').val());mQuery('#campaignevent_canvasSettings_droppedY').val(mQuery('#droppedY').val());mQuery('#campaignevent_canvasSettings_decisionPath').val(mQuery('#decisionPath').val());mQuery('form[name="campaignevent"]').submit();};Mautic.submitCampaignSource=function(e){e.preventDefault();mQuery('#campaign_leadsource_droppedX').val(mQuery('#droppedX').val());mQuery('#campaign_leadsource_droppedY').val(mQuery('#droppedY').val());mQuery('form[name="campaign_leadsource"]').submit();};Mautic.renderCampaignViewsBarChart=function(container){if(!mQuery('#campaign-views-chart').length){return;}
chartData=mQuery.parseJSON(mQuery('#campaign-views-chart-data').text());if(typeof chartData.labels==="undefined"){return;}
var ctx=document.getElementById("campaign-views-chart").getContext("2d");var options={scaleShowGridLines:false,barShowStroke:false,barValueSpacing:1,showScale:false,tooltipFontSize:10,tooltipCaretSize:0}
if(typeof Mautic.campaignViewsBarChart==='undefined'){Mautic.campaignViewsBarChart=new Chart(ctx).Bar(chartData,options);}};Mautic.renderCampaignLeadsBarChart=function(container){if(!mQuery('#campaign-leads-chart').length){return;}
chartData=mQuery.parseJSON(mQuery('#campaign-leads-chart-data').text());if(typeof chartData.labels==="undefined"){return;}
var ctx=document.getElementById("campaign-leads-chart").getContext("2d");var options={scaleShowGridLines:false,barShowStroke:false,barValueSpacing:1,showScale:false,tooltipFontSize:10,tooltipCaretSize:0}
if(typeof Mautic.campaignLeadsBarChart==='undefined'){Mautic.campaignLeadsBarChart=new Chart(ctx).Bar(chartData,options);}};Mautic.renderCampaignEmailSentPie=function(){if(typeof Mautic.campaignEmailSentPie==='object'){return;}
var element=mQuery('#emails-sent-rate');if(!element.length){return;}
var options={responsive:false,tooltipFontSize:10,tooltipTemplate:"<%if (label){%><%}%><%= value %>x <%=label%>"};var timesOnSiteData=mQuery.parseJSON(mQuery('#emails-sent-data').text());timesOnSiteData=Mautic.emulateNoDataForPieChart(timesOnSiteData);var ctx=document.getElementById("emails-sent-rate").getContext("2d");Mautic.campaignEmailSentPie=new Chart(ctx).Pie(timesOnSiteData,options);};;Mautic.categoryOnLoad=function(container,response){if(mQuery(container+' #list-search').length){Mautic.activateSearchAutocomplete('list-search','category');}
if(response&&response.inForm){var newOption=mQuery('<option />').val(response.categoryId);newOption.html(response.categoryName);mQuery(".category-select option:last").prev().before(newOption);newOption.prop('selected',true);mQuery('.category-select').trigger("chosen:updated");}};Mautic.onCategoryChange=function(catEl,route,header){if(mQuery(catEl).val()=='new'){Mautic.loadAjaxModal('#MauticSharedModal',route,'get',header);}};;Mautic.configOnLoad=function(container){Mautic.hideSpecificConfigFields();mQuery('form[name="config"]').change(function(){Mautic.hideSpecificConfigFields();});};Mautic.hideSpecificConfigFields=function(){var form=mQuery('form[name="config"]');var fields={};form.find('[data-show-on]').each(function(index,el){var field=mQuery(el);var showOn=jQuery.parseJSON(field.attr('data-show-on'));mQuery.each(showOn,function(fieldId,condition){if(typeof fields[field.attr('id')]=='undefined'||fields[field.attr('id')]!==true){if(mQuery('#'+fieldId).is(':checkbox')||mQuery('#'+fieldId).is(':radio')){if((condition=='checked'&&mQuery('#'+fieldId).is(':checked'))||(condition==''&&!mQuery('#'+fieldId).is(':checked'))){fields[field.attr('id')]=true;}else{fields[field.attr('id')]=false;}}else{var sourceFieldVal=mQuery('#'+fieldId).val();if(mQuery.inArray(sourceFieldVal,condition)===-1){fields[field.attr('id')]=false;}else{fields[field.attr('id')]=true;}}}});});form.find('[data-hide-on]').each(function(index,el){var field=mQuery(el);var hideOn=jQuery.parseJSON(field.attr('data-hide-on'));mQuery.each(hideOn,function(fieldId,condition){if(mQuery('#'+fieldId).is(':checkbox')||mQuery('#'+fieldId).is(':radio')){if((condition=='checked'&&mQuery('#'+fieldId).is(':checked'))||(condition==''&&!mQuery('#'+fieldId).is(':checked'))){fields[field.attr('id')]=false;}else{fields[field.attr('id')]=true;}}else{var sourceFieldVal=mQuery('#'+fieldId).val();if(mQuery.inArray(sourceFieldVal,condition)!==-1){fields[field.attr('id')]=false;}else if(typeof fields[field.attr('id')]=='undefined'){fields[field.attr('id')]=true;}}});});mQuery.each(fields,function(fieldId,show){var fieldContainer=mQuery('#'+fieldId).closest('[class*="col-"]');;if(show){fieldContainer.fadeIn();}else{fieldContainer.fadeOut();}});};;Mautic.dashboardOnLoad=function(container){Mautic.renderDashboardMap();Mautic.renderReturnRateDoughnut();Mautic.renderClickRateDoughnut();Mautic.updateActiveVisitorCount();Mautic.setModeratedInterval('ActiveVisitorsLoop','updateActiveVisitorCount',5000);};Mautic.dashboardOnUnload=function(id){mQuery('.jvectormap-tip').remove();if(id==='#app-content'){delete Mautic.dashboardMapData;Mautic.dashboardMap.remove();delete Mautic.dashboardClickRateDoughnutObject;delete Mautic.dashboardReturnRateDoughnutObject;delete Mautic.ActiveVisitorsCount;}
Mautic.clearModeratedInterval('ActiveVisitorsLoop');};Mautic.renderDashboardMap=function(){if(typeof Mautic.dashboardMapData==='object'){return;}
Mautic.dashboardMapData=mQuery.parseJSON(mQuery('#dashboard-map-data').text());var element=mQuery('#dashboard-map');element.vectorMap({backgroundColor:'transparent',zoomOnScroll:false,regionStyle:{initial:{fill:'#dce0e5',"fill-opacity":1,stroke:'none',"stroke-width":0,"stroke-opacity":1},hover:{"fill-opacity":0.7,cursor:'pointer'}},map:'world_mill_en',series:{regions:[{values:Mautic.dashboardMapData,scale:['#C8EEFF','#006491'],normalizeFunction:'polynomial'}]},onRegionTipShow:function(event,label,index){if(Mautic.dashboardMapData[index]>0){label.html('<b>'+label.html()+'</b></br>'+
Mautic.dashboardMapData[index]+' Leads');}}});Mautic.dashboardMap=element.vectorMap('get','mapObject');}
Mautic.renderReturnRateDoughnut=function(){if(typeof Mautic.dashboardReturnRateDoughnutObject==='object'){return;}
var element=mQuery('#return-rate');var visitCount=+element.attr('data-visit-count');var returnCount=+element.attr('data-return-count');var options={percentageInnerCutout:65,responsive:false}
var data=[{value:returnCount,color:"#4E5D9D",highlight:"#353F6A",label:"Returned"},{value:visitCount-returnCount,color:"#efeeec",highlight:"#EBEBEB",label:"Unique"}];data=Mautic.emulateNoDataForPieChart(data);var ctx=document.getElementById("return-rate").getContext("2d");Mautic.dashboardReturnRateDoughnutObject=new Chart(ctx).Doughnut(data,options);}
Mautic.renderClickRateDoughnut=function(){if(typeof Mautic.dashboardClickRateDoughnutObject==='object'){return;}
var element=mQuery('#click-rate');var readCount=+element.attr('data-sent-count');var clickCount=+element.attr('data-click-count');var options={percentageInnerCutout:65,responsive:false}
var data=[{value:clickCount,color:"#35B4B9",highlight:"#227276",label:"Clicked"},{value:readCount-clickCount,color:"#efeeec",highlight:"#EBEBEB",label:"Not clicked"}];data=Mautic.emulateNoDataForPieChart(data);var ctx=document.getElementById("click-rate").getContext("2d");Mautic.dashboardClickRateDoughnutObject=new Chart(ctx).Doughnut(data,options);}
Mautic.updateActiveVisitorCount=function(){mQuery.ajax({url:mauticAjaxUrl,type:"POST",data:"action=dashboard:viewingVisitors",dataType:"json",success:function(response){if(response.success){var element=mQuery('#active-visitors');element.text(response.viewingVisitors);if(response.viewingVisitors!=Mautic.ActiveVisitorsCount){var color='#34D43B';if(Mautic.ActiveVisitorsCount>response.viewingVisitors){color='#BC2525';}
element.css('text-shadow',color+' 0px 0px 50px');setTimeout(function(){element.css('text-shadow','#fff 0px 0px 50px');},3000);}
Mautic.ActiveVisitorsCount=response.viewingVisitors;}
Mautic.moderatedIntervalCallbackIsComplete('ActiveVisitorsLoop');},error:function(request,textStatus,errorThrown){Mautic.processAjaxError(request,textStatus,errorThrown);Mautic.moderatedIntervalCallbackIsComplete('ActiveVisitorsLoop');}});};Mautic.testMonitoredEmailServerConnection=function(mailbox){var data={host:mQuery('#config_emailconfig_monitored_email_'+mailbox+'_host').val(),port:mQuery('#config_emailconfig_monitored_email_'+mailbox+'_port').val(),encryption:mQuery('#config_emailconfig_monitored_email_'+mailbox+'_encryption').val(),user:mQuery('#config_emailconfig_monitored_email_'+mailbox+'_user').val(),password:mQuery('#config_emailconfig_monitored_email_'+mailbox+'_password').val(),mailbox:mailbox};var abortCall=false;if(!data.host){mQuery('#config_emailconfig_monitored_email_'+mailbox+'_host').parent().addClass('has-error');abortCall=true;}else{mQuery('#config_emailconfig_monitored_email_'+mailbox+'_host').parent().removeClass('has-error');}
if(!data.port){mQuery('#config_emailconfig_monitored_email_'+mailbox+'_port').parent().addClass('has-error');abortCall=true;}else{mQuery('#config_emailconfig_monitored_email_'+mailbox+'_port').parent().removeClass('has-error');}
if(abortCall){return;}
mQuery('#'+mailbox+'TestButtonContainer .fa-spinner').removeClass('hide');Mautic.ajaxActionRequest('email:testMonitoredEmailServerConnection',data,function(response){var theClass=(response.success)?'has-success':'has-error';var theMessage=response.message;mQuery('#'+mailbox+'TestButtonContainer').removeClass('has-success has-error').addClass(theClass);mQuery('#'+mailbox+'TestButtonContainer .help-block').html(theMessage);mQuery('#'+mailbox+'TestButtonContainer .fa-spinner').addClass('hide');if(response.folders){if(mailbox=='general'){mQuery('select[data-imap-folders]').each(function(index){var thisMailbox=mQuery(this).data('imap-folders');if(mQuery('#config_emailconfig_monitored_email_'+thisMailbox+'_override_settings_0').is(':checked')){var folder='#config_emailconfig_monitored_email_'+thisMailbox+'_folder';var curVal=mQuery(folder).val();mQuery(folder).html(response.folders);mQuery(folder).val(curVal);mQuery(folder).trigger('chosen:updated');}});}else{var folder='#config_emailconfig_monitored_email_'+mailbox+'_folder';var curVal=mQuery(folder).val();mQuery(folder).html(response.folders);mQuery(folder).val(curVal);mQuery(folder).trigger('chosen:updated');}}});};Mautic.testEmailServerConnection=function(sendEmail){var data={transport:mQuery('#config_emailconfig_mailer_transport').val(),host:mQuery('#config_emailconfig_mailer_host').val(),port:mQuery('#config_emailconfig_mailer_port').val(),encryption:mQuery('#config_emailconfig_mailer_encryption').val(),authMode:mQuery('#config_emailconfig_mailer_auth_mode').val(),user:mQuery('#config_emailconfig_mailer_user').val(),password:mQuery('#config_emailconfig_mailer_password').val(),from_name:mQuery('#config_emailconfig_mailer_from_name').val(),from_email:mQuery('#config_emailconfig_mailer_from_email').val(),send_test:(typeof sendEmail!=='undefined')?sendEmail:false};mQuery('#mailerTestButtonContainer .fa-spinner').removeClass('hide');Mautic.ajaxActionRequest('email:testEmailServerConnection',data,function(response){var theClass=(response.success)?'has-success':'has-error';var theMessage=response.message;mQuery('#mailerTestButtonContainer').removeClass('has-success has-error').addClass(theClass);mQuery('#mailerTestButtonContainer .help-block').html(theMessage);mQuery('#mailerTestButtonContainer .fa-spinner').addClass('hide');});};;Mautic.emailOnLoad=function(container,response){if(response&&response.updateSelect){var newOption=mQuery('<option />').val(response.emailId);newOption.html(response.emailName);var opener=window.opener;if(opener){var el='#'+response.updateSelect;var optgroup=el+" optgroup[label="+response.emailLang+"]";if(opener.mQuery(optgroup).length){opener.mQuery(optgroup+" option:last").prev().before(newOption);}else{var newOptgroup=mQuery('<optgroup label="'+response.emailLang+'" />');newOption.appendTo(newOptgroup);opener.mQuery(newOptgroup).appendTo(opener.mQuery(el));}
var chooseOneOption=opener.mQuery(el+' option:first');var optionGroups=opener.mQuery(el+' optgroup');optionGroups.sort(function(a,b){var aLabel=mQuery(a).attr('label');var bLabel=mQuery(b).attr('label');if(aLabel>bLabel){return 1;}else if(aLabel<bLabel){return-1;}else{return 0}});optionGroups.each(function(){var options=mQuery(this).children();options.sort(function(a,b){if(a.text>b.text){return 1;}else if(a.text<b.text){return-1;}else{return 0}});mQuery(this).html(options);});if(opener.mQuery(el).prop('disabled')){opener.mQuery(el).prop('disabled',false);chooseOneOption=mQuery('<option value="">'+mauticLang.chosenChooseOne+'</option>');}
opener.mQuery(el).html(chooseOneOption);optionGroups.appendTo(opener.mQuery(el));newOption.prop('selected',true);opener.mQuery(el).trigger("chosen:updated");}
window.close();}else if(mQuery('#emailform_plainText').length){var plainText=mQuery('#emailform_plainText').val();mQuery('#emailform_plainText').val('');var events=Mautic.getGlobalEditorEvents();events.instanceReady=function(event){event.editor.insertText(plainText);};mQuery('#emailform_plainText').ckeditor({removePlugins:'elementspath,toolbar',extraPlugins:'tokens',autoParagraph:false,height:"235px",on:events});if(mQuery('#emailform_emailType').val()==''){mQuery('body').addClass('noscroll');}
Mautic.toggleBuilderButton(mQuery('#emailform_template').val()=='');}else if(mQuery(container+' #list-search').length){Mautic.activateSearchAutocomplete('list-search','email');}else{if(typeof Mautic.listCompareChart==='undefined'){Mautic.renderListCompareChart();}
if(typeof Mautic.emailStatsLineGraph==='undefined'){Mautic.renderEmailStatsChart();}
Mautic.variantChartData='variant';var switchChartData;switchChartData=function(){Mautic.variantChartData=mQuery(this).data('chart');mQuery(this).replaceWith(function(){return'<span data-chart="'+Mautic.variantChartData+'">'+mQuery(this).text()+'</span>';});var opposite=(Mautic.variantChartData=='variant')?'all':'variant';mQuery('span[data-chart="'+opposite+'"]').replaceWith(function(){return'<a href="javascript:void(0)" data-chart="'+opposite+'">'+mQuery(this).text()+'</a>';});mQuery('a[data-chart="'+opposite+'"]').on('click',switchChartData);if(mQuery('#time-scopes').length){var activeButton=mQuery('#time-scopes').parent().find('a').filter(function(index){return mQuery.trim(mQuery(this).text())===mQuery.trim(mQuery('#time-scopes span.button-label').text());});activeButton[0].click();}else{Mautic.updateListCompareChart();}};mQuery('a[data-chart]').on('click',switchChartData);}};Mautic.emailOnUnload=function(id){if(id==='#app-content'){delete Mautic.listCompareChart;delete Mautic.emailStatsLineGraph;}
if(mQuery('#emailform_plainText').length){CKEDITOR.instances['emailform_plainText'].destroy(true);}};Mautic.renderListCompareChart=function(chartData){if(!mQuery("#list-compare-chart").length){return;}
if(!chartData){var chartData=mQuery.parseJSON(mQuery('#list-compare-chart-data').text());}else if(chartData.stats){chartData=chartData.stats;}
var options={legendTemplate:"<% for (var i=0; i<datasets.length; i++){%><span class=\"label label-default mr-xs\" style=\"background-color:<%=datasets[i].fillColor%>\"><%if(datasets[i].label){%><%=datasets[i].label%><%}%></span><%}%>"};Mautic.listCompareChart=new Chart(document.getElementById("list-compare-chart").getContext("2d")).Bar(chartData,options);var legendHolder=document.createElement('div');legendHolder.innerHTML=Mautic.listCompareChart.generateLegend();mQuery('#legend').html(legendHolder);Mautic.listCompareChart.update();};Mautic.updateListCompareChart=function(){var emailId=Mautic.getEntityId();var includeVariants=(Mautic.variantChartData=='all');var query="emailType=list&emailId="+emailId+"&includeVariants="+includeVariants;Mautic.ajaxActionRequest('email:updateStatsChart',query,function(response){Mautic.renderListCompareChart(response);},true);};Mautic.renderEmailStatsChart=function(chartData){if(!mQuery("#stat-chart").length){return;}
var canvas=document.getElementById("stat-chart");if(!chartData){var chartData=mQuery.parseJSON(mQuery('#stat-chart-data').text());}else if(chartData.stats){chartData=chartData.stats;}
if(typeof Mautic.emailStatsLineGraph!=='undefined'){Mautic.emailStatsLineGraph.destroy();}
Mautic.emailStatsLineGraph=new Chart(canvas.getContext("2d")).Line(chartData);var legendHolder=document.createElement('div');legendHolder.innerHTML=Mautic.emailStatsLineGraph.generateLegend();mQuery('#legend').html(legendHolder.firstChild);Mautic.emailStatsLineGraph.update();};Mautic.updateEmailStatsChart=function(element,amount,unit){var emailId=Mautic.getEntityId();var includeVariants=(Mautic.variantChartData=='all');var query="emailType=template&amount="+amount+"&unit="+unit+"&emailId="+emailId+"&includeVariants="+includeVariants;Mautic.getChartData(element,'email:updateStatsChart',query,'renderEmailStatsChart');};Mautic.insertEmailBuilderToken=function(editorId,token){var editor=Mautic.getEmailBuilderEditorInstances();editor[instance].insertText(token);};Mautic.getEmailAbTestWinnerForm=function(abKey){if(abKey&&mQuery(abKey).val()&&mQuery(abKey).closest('.form-group').hasClass('has-error')){mQuery(abKey).closest('.form-group').removeClass('has-error');if(mQuery(abKey).next().hasClass('help-block')){mQuery(abKey).next().remove();}}
Mautic.activateLabelLoadingIndicator('emailform_variantSettings_winnerCriteria');var emailId=mQuery('#emailform_sessionId').val();var query="action=email:getAbTestForm&abKey="+mQuery(abKey).val()+"&emailId="+emailId;mQuery.ajax({url:mauticAjaxUrl,type:"POST",data:query,dataType:"json",success:function(response){if(typeof response.html!='undefined'){if(mQuery('#emailform_variantSettings_properties').length){mQuery('#emailform_variantSettings_properties').replaceWith(response.html);}else{mQuery('#emailform_variantSettings').append(response.html);}
if(response.html!=''){Mautic.onPageLoad('#emailform_variantSettings_properties',response);}}},error:function(request,textStatus,errorThrown){Mautic.processAjaxError(request,textStatus,errorThrown);},complete:function(){Mautic.removeLabelLoadingIndicator();}});};Mautic.loadNewEmailWindow=function(options){if(options.windowUrl){Mautic.startModalLoadingBar();setTimeout(function(){var generator=window.open(options.windowUrl,'newemailwindow','height=600,width=1100');if(!generator||generator.closed||typeof generator.closed=='undefined'){alert(response.popupBlockerMessage);}else{generator.onload=function(){Mautic.stopModalLoadingBar();Mautic.stopIconSpinPostEvent();};}},100);}};Mautic.submitSendForm=function(){Mautic.dismissConfirmation();mQuery('.btn-send').prop('disabled',true);mQuery('form[name=\'batch_send\']').submit();};Mautic.emailSendOnLoad=function(container,response){if(mQuery('.email-send-progress').length){if(!mQuery('#emailSendProgress').length){Mautic.clearModeratedInterval('emailSendProgress');}else{Mautic.setModeratedInterval('emailSendProgress','sendEmailBatch',2000);}}};Mautic.emailSendOnUnload=function(){if(mQuery('.email-send-progress').length){Mautic.clearModeratedInterval('emailSendProgress');if(typeof Mautic.sendEmailBatchXhr!='undefined'){Mautic.sendEmailBatchXhr.abort();delete Mautic.sendEmailBatchXhr;}}};Mautic.sendEmailBatch=function(){var data='id='+mQuery('.progress-bar-send').data('email')+'&pending='+mQuery('.progress-bar-send').attr('aria-valuemax')+'&batchlimit='+mQuery('.progress-bar-send').data('batchlimit');Mautic.sendEmailBatchXhr=Mautic.ajaxActionRequest('email:sendBatch',data,function(response){if(response.progress){if(response.progress[0]>0){mQuery('.imported-count').html(response.progress[0]);mQuery('.progress-bar-send').attr('aria-valuenow',response.progress[0]).css('width',response.percent+'%');mQuery('.progress-bar-send span.sr-only').html(response.percent+'%');}
if(response.progress[0]>=response.progress[1]){Mautic.clearModeratedInterval('emailSendProgress');setTimeout(function(){mQuery.ajax({type:'POST',showLoadingBar:false,url:window.location,data:'complete=1',success:function(response){if(response.newContent){Mautic.processPageContent(response);}}});},1000);}}
Mautic.moderatedIntervalCallbackIsComplete('emailSendProgress');});};Mautic.autoGeneratePlaintext=function(){mQuery('.plaintext-spinner').removeClass('hide');var mode=(mQuery('#emailform_template').val()=='')?'custom':'template';var custom=mQuery('#emailform_customHtml').val();var id=mQuery('#emailform_sessionId').val();var data={mode:mode,id:id,custom:custom};Mautic.ajaxActionRequest('email:generatePlaintText',data,function(response){CKEDITOR.instances['emailform_plainText'].insertText(response.text);mQuery('.plaintext-spinner').addClass('hide');});};Mautic.selectEmailType=function(emailType){if(emailType=='list'){mQuery('#leadList').removeClass('hide');mQuery('#publishStatus').addClass('hide');mQuery('.page-header h3').text(mauticLang.newListEmail);}else{mQuery('#publishStatus').removeClass('hide');mQuery('#leadList').addClass('hide');mQuery('.page-header h3').text(mauticLang.newTemplateEmail);}
mQuery('#emailform_emailType').val(emailType);mQuery('body').removeClass('noscroll');mQuery('.email-type-modal').remove();mQuery('.email-type-modal-backdrop').remove();};Mautic.getTotalAttachmentSize=function(){var assets=mQuery('#emailform_assetAttachments').val();if(assets){assets={'assets':assets};Mautic.ajaxActionRequest('email:getAttachmentsSize',assets,function(response){mQuery('#attachment-size').text(response.size);});}else{mQuery('#attachment-size').text('0');}};;Mautic.formOnLoad=function(container){if(mQuery(container+' #list-search').length){Mautic.activateSearchAutocomplete('list-search','form.form');}
if(mQuery('#mauticforms_fields')){mQuery('#mauticforms_fields').sortable({items:'.mauticform-row',handle:'.reorder-handle',stop:function(i){mQuery.ajax({type:"POST",url:mauticAjaxUrl+"?action=form:reorderFields",data:mQuery('#mauticforms_fields').sortable("serialize")+"&formId="+mQuery('#mauticform_sessionId').val()})}});mQuery('#mauticforms_fields .mauticform-row').on('mouseover.mauticformfields',function(){mQuery(this).find('.form-buttons').removeClass('hide');}).on('mouseout.mauticformfields',function(){mQuery(this).find('.form-buttons').addClass('hide');}).on('dblclick.mauticformfields',function(event){event.preventDefault();mQuery(this).find('.btn-edit').first().click();});}
if(mQuery('#mauticforms_actions')){mQuery('#mauticforms_actions').sortable({items:'.mauticform-row',handle:'.reorder-handle',stop:function(i){mQuery.ajax({type:"POST",url:mauticAjaxUrl+"?action=form:reorderActions",data:mQuery('#mauticforms_actions').sortable("serialize")+"&formId="+mQuery('#mauticform_sessionId').val()});}});mQuery('#mauticforms_actions .mauticform-row').on('mouseover.mauticformactions',function(){mQuery(this).find('.form-buttons').removeClass('hide');}).on('mouseout.mauticformactions',function(){mQuery(this).find('.form-buttons').addClass('hide');}).on('dblclick.mauticformactions',function(event){event.preventDefault();mQuery(this).find('.btn-edit').first().click();});}
if(mQuery('#mauticform_formType').length&&mQuery('#mauticform_formType').val()==''){mQuery('body').addClass('noscroll');}
if(typeof Mautic.formSubmissionChart==='undefined'){Mautic.renderSubmissionChart();}};Mautic.updateFormFields=function(){Mautic.activateLabelLoadingIndicator('campaignevent_properties_field');var formId=mQuery('#campaignevent_properties_form').val();Mautic.ajaxActionRequest('form:updateFormFields',{'formId':formId},function(response){if(response.fields){var select=mQuery('#campaignevent_properties_field');select.find('option').remove();var fieldOptions={};mQuery.each(response.fields,function(key,field){var option=mQuery('<option></option>').attr('value',field.alias).text(field.label);select.append(option);fieldOptions[field.alias]=field.options;});select.attr('data-field-options',JSON.stringify(fieldOptions));select.trigger('chosen:updated');Mautic.updateFormFieldValues(select);}
Mautic.removeLabelLoadingIndicator();});};Mautic.updateFormFieldValues=function(field){field=mQuery(field);var fieldValue=field.val();var options=jQuery.parseJSON(field.attr('data-field-options'));var valueField=mQuery('#campaignevent_properties_value');var valueFieldAttrs={'class':valueField.attr('class'),'id':valueField.attr('id'),'name':valueField.attr('name'),'autocomplete':valueField.attr('autocomplete'),'value':valueField.attr('value')};if(typeof options[fieldValue]!=='undefined'&&!mQuery.isEmptyObject(options[fieldValue])){var newValueField=mQuery('<select/>').attr('class',valueFieldAttrs['class']).attr('id',valueFieldAttrs['id']).attr('name',valueFieldAttrs['name']).attr('autocomplete',valueFieldAttrs['autocomplete']).attr('value',valueFieldAttrs['value']);mQuery.each(options[fieldValue],function(key,optionVal){var option=mQuery("<option></option>").attr('value',optionVal).text(optionVal);newValueField.append(option);});valueField.replaceWith(newValueField);}else{var newValueField=mQuery('<input/>').attr('type','text').attr('class',valueFieldAttrs['class']).attr('id',valueFieldAttrs['id']).attr('name',valueFieldAttrs['name']).attr('autocomplete',valueFieldAttrs['autocomplete']).attr('value',valueFieldAttrs['value']);valueField.replaceWith(newValueField);}};Mautic.formOnUnload=function(id){if(id==='#app-content'){delete Mautic.formSubmissionChart;}};Mautic.formFieldOnLoad=function(container,response){if(response.fieldHtml){var newHtml=response.fieldHtml;var fieldId='#mauticform_'+response.fieldId;if(mQuery(fieldId).length){mQuery(fieldId).replaceWith(newHtml);var newField=false;}else{mQuery(newHtml).insertBefore('#mauticforms_fields .mauticform-button-wrapper');var newField=true;}
mQuery(fieldId+" a[data-toggle='ajax']").click(function(event){event.preventDefault();return Mautic.ajaxifyLink(this,event);});mQuery(fieldId+" *[data-toggle='tooltip']").tooltip({html:true});mQuery(fieldId+" a[data-toggle='ajaxmodal']").on('click.ajaxmodal',function(event){event.preventDefault();Mautic.ajaxifyModal(this,event);});mQuery('#mauticforms_fields .mauticform-row').off(".mauticform");mQuery('#mauticforms_fields .mauticform-row').on('mouseover.mauticformfields',function(){mQuery(this).find('.form-buttons').removeClass('hide');}).on('mouseout.mauticformfields',function(){mQuery(this).find('.form-buttons').addClass('hide');}).on('dblclick.mauticformfields',function(event){event.preventDefault();mQuery(this).find('.btn-edit').first().click();});if(!mQuery('#fields-panel').hasClass('in')){mQuery('a[href="#fields-panel"]').trigger('click');}
if(newField){mQuery('.bundle-main-inner-wrapper').scrollTop(mQuery('.bundle-main-inner-wrapper').height());}
if(mQuery('#form-field-placeholder').length){mQuery('#form-field-placeholder').remove();}}};Mautic.formActionOnLoad=function(container,response){if(response.actionHtml){var newHtml=response.actionHtml;var actionId='#mauticform_action_'+response.actionId;if(mQuery(actionId).length){mQuery(actionId).replaceWith(newHtml);var newField=false;}else{mQuery(newHtml).appendTo('#mauticforms_actions');var newField=true;}
mQuery(actionId+" a[data-toggle='ajax']").click(function(event){event.preventDefault();return Mautic.ajaxifyLink(this,event);});mQuery(actionId+" *[data-toggle='tooltip']").tooltip({html:true});mQuery(actionId+" a[data-toggle='ajaxmodal']").on('click.ajaxmodal',function(event){event.preventDefault();Mautic.ajaxifyModal(this,event);});mQuery('#mauticforms_actions .mauticform-row').off(".mauticform");mQuery('#mauticforms_actions .mauticform-row').on('mouseover.mauticformactions',function(){mQuery(this).find('.form-buttons').removeClass('hide');}).on('mouseout.mauticformactions',function(){mQuery(this).find('.form-buttons').addClass('hide');}).on('dblclick.mauticformactions',function(event){event.preventDefault();mQuery(this).find('.btn-edit').first().click();});if(!mQuery('#actions-panel').hasClass('in')){mQuery('a[href="#actions-panel"]').trigger('click');}
if(newField){mQuery('.bundle-main-inner-wrapper').scrollTop(mQuery('.bundle-main-inner-wrapper').height());}
if(mQuery('#form-action-placeholder').length){mQuery('#form-action-placeholder').remove();}}};Mautic.onPostSubmitActionChange=function(value){if(value=='return'){mQuery('#mauticform_postActionProperty').prev().removeClass('required');}else{mQuery('#mauticform_postActionProperty').prev().addClass('required');}
mQuery('#mauticform_postActionProperty').next().html('');mQuery('#mauticform_postActionProperty').parent().removeClass('has-error');};Mautic.renderSubmissionChart=function(chartData){if(!mQuery('#submission-chart').length){return;}
if(!chartData){chartData=mQuery.parseJSON(mQuery('#submission-chart-data').text());}else if(chartData.stats){chartData=chartData.stats;}
var ctx=document.getElementById("submission-chart").getContext("2d");var options={};if(typeof Mautic.formSubmissionChart==='undefined'){Mautic.formSubmissionChart=new Chart(ctx).Line(chartData,options);}else{Mautic.formSubmissionChart.destroy();Mautic.formSubmissionChart=new Chart(ctx).Line(chartData,options);}};Mautic.updateSubmissionChart=function(element,amount,unit){var formId=Mautic.getEntityId();var query="amount="+amount+"&unit="+unit+"&formId="+formId;Mautic.getChartData(element,'form:updateSubmissionChart',query,'renderSubmissionChart');}
Mautic.selectFormType=function(formType){if(formType=='standalone'){mQuery('#actions-tab').removeClass('hide');mQuery('#actions-container').removeClass('hide')
mQuery('.page-header h3').text(mauticLang.newStandaloneForm);}else{mQuery('#actions-tab').addClass('hide');mQuery('#actions-container').addClass('hide');mQuery('.page-header h3').text(mauticLang.newCampaignForm);}
mQuery('#mauticform_formType').val(formType);mQuery('body').removeClass('noscroll');mQuery('.form-type-modal').remove();mQuery('.form-type-modal-backdrop').remove();};;Mautic.leadOnLoad=function(container){Mousetrap.bind('a',function(e){if(mQuery('#lead-quick-add').length){mQuery('#lead-quick-add').modal();}else if(mQuery('#addNoteButton').length){mQuery('#addNoteButton').click();}});Mousetrap.bind('t',function(e){mQuery('#table-view').click();});Mousetrap.bind('c',function(e){mQuery('#card-view').click();});Mousetrap.bind('n',function(e){mQuery('#new-lead').click();});Mousetrap.bind('mod+enter',function(e){if(mQuery('#leadnote_buttons_save').length){mQuery('#leadnote_buttons_save').click();}else if(mQuery('#save-quick-add').length){mQuery('#save-quick-add').click();}});Mousetrap.stopCallback=function(e,element,combo){if(element.id=='leadnote_text'&&combo!='mod+enter'){return true;}
if((' '+element.className+' ').indexOf(' mousetrap ')>-1){return false;}
return element.tagName=='INPUT'||element.tagName=='SELECT'||element.tagName=='TEXTAREA'||(element.contentEditable&&element.contentEditable=='true');};if(mQuery(container+' form[name="lead"]').length){mQuery("*[data-toggle='field-lookup']").each(function(index){var target=mQuery(this).attr('data-target');var field=mQuery(this).attr('id');var options=mQuery(this).attr('data-options');Mautic.activateLeadFieldTypeahead(field,target,options);});Mautic.updateLeadFieldProperties(mQuery('#leadfield_type').val());}
var timelineForm=mQuery(container+' #timeline-filters');if(timelineForm.length){timelineForm.on('change',function(){timelineForm.submit();}).on('keyup',function(){timelineForm.delay(200).submit();}).on('submit',function(e){e.preventDefault();Mautic.refreshLeadTimeline(timelineForm);});}
var noteForm=mQuery(container+' #note-filters');if(noteForm.length){noteForm.on('change',function(){noteForm.submit();}).on('keyup',function(){noteForm.delay(200).submit();}).on('submit',function(e){e.preventDefault();Mautic.refreshLeadNotes(noteForm);});}
if(mQuery(container+' #list-search').length){Mautic.activateSearchAutocomplete('list-search','lead.lead');}
if(mQuery(container+' #notes-container').length){Mautic.activateSearchAutocomplete('NoteFilter','lead.note');}
if(typeof Mautic.leadEngagementChart==='undefined'){Mautic.renderEngagementChart();}
if(mQuery('#lead_preferred_profile_image').length){mQuery('#lead_preferred_profile_image').on('change',function(){if(mQuery(this).val()=='custom'){mQuery('#customAvatarContainer').slideDown('fast');}else{mQuery('#customAvatarContainer').slideUp('fast');}})}
if(mQuery('.lead-avatar-panel').length){mQuery('.lead-avatar-panel .avatar-collapser a.arrow').on('click',function(){setTimeout(function(){var status=(mQuery('#lead-avatar-block').hasClass('in')?'expanded':'collapsed');Cookies.set('mautic_lead_avatar_panel',status,{expires:30});},500);});}
if(mQuery('#anonymousLeadButton').length){var searchValue=mQuery('#list-search').typeahead('val').toLowerCase();var string=mQuery('#anonymousLeadButton').data('anonymous').toLowerCase();if(searchValue.indexOf(string)>=0&&searchValue.indexOf('!'+string)==-1){mQuery('#anonymousLeadButton').addClass('btn-primary');}else{mQuery('#anonymousLeadButton').removeClass('btn-primary');}}};Mautic.leadOnUnload=function(id){if(id==='#app-content'){delete Mautic.leadEngagementChart;}
if(typeof MauticVars.moderatedIntervals['leadListLiveUpdate']!='undefined'){Mautic.clearModeratedInterval('leadListLiveUpdate');}};Mautic.getLeadId=function(){return mQuery('input#leadId').val();}
Mautic.activateLeadFieldTypeahead=function(field,target,options){if(options){var keys=[],values=[];if(typeof options=='string'){options=options.split('||');if(options.length==2){keys=options[1].split('|');values=options[0].split('|');}else{values=options[0].split('|');}}else{values=options;}
var fieldTypeahead=Mautic.activateTypeahead('#'+field,{dataOptions:values,dataOptionKeys:keys,minLength:0});}else{var fieldTypeahead=Mautic.activateTypeahead('#'+field,{prefetch:true,remote:true,action:"lead:fieldList&field="+target});}
mQuery(fieldTypeahead).on('typeahead:selected',function(event,datum){if(mQuery("#"+field+"_id").length&&datum["id"]){mQuery("#"+field+"_id").val(datum["id"]);}}).on('typeahead:autocompleted',function(event,datum){if(mQuery("#"+field+"_id").length&&datum["id"]){mQuery("#"+field+"_id").val(datum["id"]);}});};Mautic.leadlistOnLoad=function(container){if(mQuery(container+' #list-search').length){Mautic.activateSearchAutocomplete('list-search','lead.list');}
if(mQuery('#leadlist_filters').length){mQuery('#available_filters').on('change',function(){if(mQuery(this).val()){Mautic.addLeadListFilter(mQuery(this).val());mQuery(this).val('');mQuery(this).trigger('chosen:updated');}});mQuery('#leadlist_filters .remove-selected').each(function(index,el){mQuery(el).on('click',function(){mQuery(this).closest('.panel').animate({'opacity':0},'fast',function(){mQuery(this).remove();});if(!mQuery('#leadlist_filters li:not(.placeholder)').length){mQuery('#leadlist_filters li.placeholder').removeClass('hide');}else{mQuery('#leadlist_filters li.placeholder').addClass('hide');}});});}
mQuery("*[data-toggle='field-lookup']").each(function(index){var target=mQuery(this).attr('data-target');var options=mQuery(this).attr('data-options');var field=mQuery(this).attr('id');Mautic.activateLeadFieldTypeahead(field,target,options);});};Mautic.convertLeadFilterInput=function(el){var operator=mQuery(el).val();var regExp=/leadlist_filters_(\d+)_operator/;var matches=regExp.exec(mQuery(el).attr('id'));var filterNum=matches[1];var filterId='#leadlist_filters_'+filterNum+'_filter';if(mQuery(filterId).parent().hasClass('has-error')){mQuery(filterId).parent().find('div.help-block').hide();mQuery(filterId).parent().removeClass('has-error');}
var disabled=(operator=='empty'||operator=='!empty')?true:false;mQuery(filterId).prop('disabled',disabled);if(disabled){mQuery(filterId).val('');}
if(mQuery(filterId).is('select')){var isMultiple=mQuery(filterId).attr('multiple');var multiple=(operator=='in'||operator=='!in')?true:false;var placeholder=mQuery(filterId).attr('data-placeholder');if(multiple&&!isMultiple){mQuery(filterId).attr('multiple','multiple');var newName=mQuery(filterId).attr('name')+'[]';mQuery(filterId).attr('name',newName);placeholder=mauticLang['chosenChooseMore'];}else if(!multiple&&isMultiple){mQuery(filterId).removeAttr('multiple');var newName=mQuery(filterId).attr('name').replace(/[\[\]']+/g,'')
mQuery(filterId).attr('name',newName);placeholder=mauticLang['chosenChooseOne'];}
if(multiple){mQuery(filterId).find('option[value=""]').remove();mQuery(filterId+' option:selected').removeAttr('selected');}else{mQuery(filterId).prepend("<option value='' selected></option>");}
if(mQuery(filterId+'_chosen').length){mQuery(filterId).chosen('destroy');}
mQuery(filterId).attr('data-placeholder',placeholder);Mautic.activateChosenSelect(mQuery(filterId));}};Mautic.addLeadListFilter=function(elId){var filterId='#available_'+elId;var label=mQuery(filterId).text();var filterNum=parseInt(mQuery('.available-filters').data('index'));mQuery('.available-filters').data('index',filterNum+1);var prototype=mQuery('.available-filters').data('prototype');var fieldType=mQuery(filterId).data('field-type');var isSpecial=(mQuery.inArray(fieldType,['leadlist','tags','boolean','select','country','timezone','region'])!=-1);prototype=prototype.replace(/__name__/g,filterNum);prototype=prototype.replace(/__label__/g,label);prototype=mQuery(prototype);var filterBase="leadlist[filters]["+filterNum+"]";var filterIdBase="leadlist_filters_"+filterNum+"_";if(isSpecial){var templateField=fieldType;if(fieldType=='boolean'){templateField='select';}
var template=mQuery('#templates .'+templateField+'-template').clone();mQuery(template).attr('name',mQuery(template).attr('name').replace(/__name__/g,filterNum));mQuery(template).attr('id',mQuery(template).attr('id').replace(/__name__/g,filterNum));mQuery(prototype).find('input[name="'+filterBase+'[filter]"]').replaceWith(template);}
if(mQuery('#leadlist_filters div.panel').length==0){mQuery(prototype).find(".panel-footer").addClass('hide');}
mQuery(prototype).find("a.remove-selected").on('click',function(){mQuery(this).closest('.panel').animate({'opacity':0},'fast',function(){mQuery(this).remove();});});mQuery(prototype).find("input[name='"+filterBase+"[field]']").val(elId);mQuery(prototype).find("input[name='"+filterBase+"[type]']").val(fieldType);var filterEl=(isSpecial)?"select[name='"+filterBase+"[filter]']":"input[name='"+filterBase+"[filter]']";mQuery(prototype).appendTo('#leadlist_filters');var filter='#'+filterIdBase+'filter';if(isSpecial){if(fieldType=='select'||fieldType=='boolean'){var fieldOptions=mQuery(filterId).data("field-list");mQuery.each(fieldOptions,function(index,val){mQuery('<option>').val(index).text(val).appendTo(filterEl);});}}else if(fieldType=='lookup'){var fieldCallback=mQuery(filterId).data("field-callback");if(fieldCallback&&typeof Mautic[fieldCallback]=='function'){var fieldOptions=mQuery(filterId).data("field-list");Mautic[fieldCallback](filterIdBase+'filter',elId,fieldOptions);}}else if(fieldType=='datetime'){mQuery(filter).datetimepicker({format:'Y-m-d H:i',lazyInit:true,validateOnBlur:false,allowBlank:true,scrollInput:false});}else if(fieldType=='date'){mQuery(filter).datetimepicker({timepicker:false,format:'Y-m-d',lazyInit:true,validateOnBlur:false,allowBlank:true,scrollInput:false,closeOnDateSelect:true});}else if(fieldType=='time'){mQuery(filter).datetimepicker({datepicker:false,format:'H:i',lazyInit:true,validateOnBlur:false,allowBlank:true,scrollInput:false});}else if(fieldType=='lookup_id'){var oldFilter=mQuery(filterEl);var newDisplay=mQuery(oldFilter).clone();mQuery(newDisplay).attr('name',filterBase+'[display]');var oldDisplay=mQuery(prototype).find("input[name='"+filterBase+"[display]']");var newFilter=mQuery(oldDisplay).clone();mQuery(newFilter).attr('name',filterBase+'[filter]');mQuery(oldFilter).replaceWith(newFilter);mQuery(oldDisplay).replaceWith(newDisplay);var fieldCallback=mQuery(filterId).data("field-callback");if(fieldCallback&&typeof Mautic[fieldCallback]=='function'){var fieldOptions=mQuery(filterId).data("field-list");Mautic[fieldCallback](filterIdBase+'filter',elId,fieldOptions);}}else{mQuery(filter).attr('type',fieldType);}
var operators=mQuery(filterId).data('field-operators');if(typeof operators.include!='undefined'){mQuery('#'+filterIdBase+'operator option').filter(function(){return mQuery.inArray(mQuery(this).val(),operators['include'])==-1}).remove();}else if(typeof operators.exclude!='undefined'){mQuery('#'+filterIdBase+'operator option').filter(function(){return mQuery.inArray(mQuery(this).val(),operators['exclude'])>0}).remove();}
Mautic.convertLeadFilterInput('#'+filterIdBase+'operator');};Mautic.leadfieldOnLoad=function(container){var fixHelper=function(e,ui){ui.children().each(function(){mQuery(this).width(mQuery(this).width());});return ui;};if(mQuery(container+' .leadfield-list').length){mQuery(container+' .leadfield-list tbody').sortable({handle:'.fa-ellipsis-v',helper:fixHelper,scroll:false,axis:'y',containment:container+' .leadfield-list',stop:function(i){mQuery.ajax({type:"POST",url:mauticAjaxUrl+"?action=lead:reorder&limit="+mQuery('.pagination-limit').val()+'&page='+mQuery('.pagination li.active a span').first().text(),data:mQuery(container+' .leadfield-list tbody').sortable("serialize")});}});}};Mautic.updateLeadFieldProperties=function(selectedVal){if(selectedVal=='lookup'){selectedVal='select';}
if(mQuery('#field-templates .'+selectedVal).length){mQuery('#leadfield_properties').html('');mQuery('#leadfield_properties').append(mQuery('#field-templates .'+selectedVal).clone(true));}else{mQuery('#leadfield_properties').html('');}
if(selectedVal=='time'){mQuery('#leadfield_isListable').closest('.row').addClass('hide');}else{mQuery('#leadfield_isListable').closest('.row').removeClass('hide');}
var defaultFieldType=mQuery('input[name="leadfield[defaultValue]"]').attr('type');if(selectedVal=='boolean'){if(defaultFieldType=='text'){var newDiv=mQuery('<div id="leadfield_defaultValue"></div>');var defaultBool=mQuery('#field-templates .default_bool').html();defaultBool=defaultBool.replace(/default_bool_template/g,'defaultValue');mQuery(defaultBool).appendTo(newDiv);mQuery('#leadfield_defaultValue').replaceWith(newDiv);}}else if(defaultFieldType=='radio'){var html=mQuery('#field-templates .default').html();html=html.replace(/default_template/g,'defaultValue');mQuery('#leadfield_defaultValue').replaceWith(html);}};Mautic.updateLeadFieldBooleanLabels=function(el,label){mQuery('#leadfield_defaultValue_'+label).parent().find('span').text(mQuery(el).val());};Mautic.refreshLeadSocialProfile=function(network,leadId,event){Mautic.startIconSpinOnEvent(event);var query="action=lead:updateSocialProfile&network="+network+"&lead="+leadId;mQuery.ajax({showLoadingBar:true,url:mauticAjaxUrl,type:"POST",data:query,dataType:"json",success:function(response){if(response.success){if(response.completeProfile){mQuery('#social-container').html(response.completeProfile);mQuery('#SocialCount').html(response.socialCount);}else{mQuery.each(response.profiles,function(index,value){if(mQuery('#'+index+'CompleteProfile').length){mQuery('#'+index+'CompleteProfile').html(value.newContent);}});}}
Mautic.stopPageLoadingBar();Mautic.stopIconSpinPostEvent();},error:function(request,textStatus,errorThrown){Mautic.processAjaxError(request,textStatus,errorThrown);}});};Mautic.clearLeadSocialProfile=function(network,leadId,event){Mautic.startIconSpinOnEvent(event);var query="action=lead:clearSocialProfile&network="+network+"&lead="+leadId;mQuery.ajax({url:mauticAjaxUrl,type:"POST",data:query,dataType:"json",success:function(response){if(response.success){mQuery('.'+network+'-panelremove').click();if(response.completeProfile){mQuery('#social-container').html(response.completeProfile);}
mQuery('#SocialCount').html(response.socialCount);}
Mautic.stopIconSpinPostEvent();},error:function(request,textStatus,errorThrown){Mautic.processAjaxError(request,textStatus,errorThrown);Mautic.stopIconSpinPostEvent();}});};Mautic.refreshLeadTimeline=function(form){var formData=form.serialize()
mQuery.ajax({showLoadingBar:true,url:mauticAjaxUrl,type:"POST",data:"action=lead:updateTimeline&"+formData,dataType:"json",success:function(response){if(response.success){Mautic.stopPageLoadingBar();mQuery('#timeline-container').html(response.timeline);mQuery('#HistoryCount').html(response.historyCount);}},error:function(request,textStatus,errorThrown){Mautic.processAjaxError(request,textStatus,errorThrown);}});};Mautic.refreshLeadNotes=function(form){Mautic.postForm(mQuery(form),function(response){response.target='#NoteList';mQuery('#NoteCount').html(response.noteCount);Mautic.processPageContent(response);});};Mautic.toggleLeadList=function(toggleId,leadId,listId){var action=mQuery('#'+toggleId).hasClass('fa-toggle-on')?'remove':'add';var query="action=lead:toggleLeadList&leadId="+leadId+"&listId="+listId+"&listAction="+action;Mautic.toggleLeadSwitch(toggleId,query,action);};Mautic.toggleLeadCampaign=function(toggleId,leadId,campaignId){var action=mQuery('#'+toggleId).hasClass('fa-toggle-on')?'remove':'add';var query="action=lead:toggleLeadCampaign&leadId="+leadId+"&campaignId="+campaignId+"&campaignAction="+action;Mautic.toggleLeadSwitch(toggleId,query,action);};Mautic.toggleLeadSwitch=function(toggleId,query,action){var toggleOn='fa-toggle-on text-success';var toggleOff='fa-toggle-off text-danger';var spinClass='fa-spin fa-spinner ';if(action=='remove'){mQuery('#'+toggleId).removeClass(toggleOn).addClass(spinClass+'text-danger');}else{mQuery('#'+toggleId).removeClass(toggleOff).addClass(spinClass+'text-success');}
mQuery.ajax({url:mauticAjaxUrl,type:"POST",data:query,dataType:"json",success:function(response){mQuery('#'+toggleId).removeClass(spinClass);if(!response.success){if(action=='remove'){mQuery('#'+toggleId).removeClass(toggleOff).addClass(toggleOn);}else{mQuery('#'+toggleId).removeClass(toggleOn).addClass(toggleOff);}}else{if(action=='remove'){mQuery('#'+toggleId).removeClass(toggleOn).addClass(toggleOff);}else{mQuery('#'+toggleId).removeClass(toggleOff).addClass(toggleOn);}}},error:function(request,textStatus,errorThrown){mQuery('#'+toggleId).removeClass(spinClass);if(action=='remove'){mQuery('#'+toggleId).removeClass(toggleOff).addClass(toggleOn);}else{mQuery('#'+toggleId).removeClass(toggleOn).addClass(toggleOff);}}});};Mautic.leadNoteOnLoad=function(container,response){if(response.noteHtml){var el='#LeadNote'+response.noteId;if(mQuery(el).length){mQuery(el).replaceWith(response.noteHtml);}else{mQuery('#LeadNotes').prepend(response.noteHtml);}
mQuery(el+" *[data-toggle='ajaxmodal']").off('click.ajaxmodal');mQuery(el+" *[data-toggle='ajaxmodal']").on('click.ajaxmodal',function(event){event.preventDefault();Mautic.ajaxifyModal(this,event);});mQuery(el+" a[data-toggle='ajax']").off('click.ajax');mQuery(el+" a[data-toggle='ajax']").on('click.ajax',function(event){event.preventDefault();return Mautic.ajaxifyLink(this,event);});}else if(response.deleteId&&mQuery('#LeadNote'+response.deleteId).length){mQuery('#LeadNote'+response.deleteId).remove();}
if(response.upNoteCount||response.noteCount||response.downNoteCount){if(response.upNoteCount||response.downNoteCount){var count=parseInt(mQuery('#NoteCount').html());count=(response.upNoteCount)?count+1:count-1;}else{var count=parseInt(response.noteCount);}
mQuery('#NoteCount').html(count);}};Mautic.renderEngagementChart=function(){if(!mQuery("#chart-engagement").length){return;}
var canvas=document.getElementById("chart-engagement");var chartData=mQuery.parseJSON(mQuery('#chart-engagement-data').text());Mautic.leadEngagementChart=new Chart(canvas.getContext("2d")).Line(chartData);var legendHolder=document.createElement('div');legendHolder.innerHTML=Mautic.leadEngagementChart.generateLegend();mQuery('#engagement-legend').html(legendHolder.firstChild);Mautic.leadEngagementChart.update();};Mautic.showSocialMediaImageModal=function(imgSrc){mQuery('#socialImageModal img').attr('src',imgSrc);mQuery('#socialImageModal').modal('show');};Mautic.leadImportOnLoad=function(container,response){if(!mQuery('#leadImportProgress').length){Mautic.clearModeratedInterval('leadImportProgress');}else{Mautic.setModeratedInterval('leadImportProgress','reloadLeadImportProgress',3000);}};Mautic.reloadLeadImportProgress=function(){if(!mQuery('#leadImportProgress').length){Mautic.clearModeratedInterval('leadImportProgress');}else{Mautic.ajaxActionRequest('lead:getImportProgress',{},function(response){if(response.progress){if(response.progress[0]>0){mQuery('.imported-count').html(response.progress[0]);mQuery('.progress-bar-import').attr('aria-valuenow',response.progress[0]).css('width',response.percent+'%');mQuery('.progress-bar-import span.sr-only').html(response.percent+'%');}}});mQuery.ajax({showLoadingBar:false,url:window.location+'?importbatch=1',success:function(response){Mautic.moderatedIntervalCallbackIsComplete('leadImportProgress');if(response.newContent){Mautic.processPageContent(response);}}});}};Mautic.removeBounceStatus=function(el,dncId){mQuery(el).removeClass('fa-times').addClass('fa-spinner fa-spin');Mautic.ajaxActionRequest('lead:removeBounceStatus','id='+dncId,function(){mQuery('#bounceLabel'+dncId).tooltip('destroy');mQuery('#bounceLabel'+dncId).fadeOut(300,function(){mQuery(this).remove();});});};Mautic.toggleLiveLeadListUpdate=function(){if(typeof MauticVars.moderatedIntervals['leadListLiveUpdate']=='undefined'){Mautic.setModeratedInterval('leadListLiveUpdate','updateLeadList',5000);mQuery('#liveModeButton').addClass('btn-primary');}else{Mautic.clearModeratedInterval('leadListLiveUpdate');mQuery('#liveModeButton').removeClass('btn-primary');}};Mautic.updateLeadList=function(){var maxLeadId=mQuery('#liveModeButton').data('max-id');mQuery.ajax({url:mauticAjaxUrl,type:"get",data:"action=lead:getNewLeads&maxId="+maxLeadId,dataType:"json",success:function(response){if(response.leads){if(response.indexMode=='list'){mQuery('#leadTable tbody').prepend(response.leads);}else{var items=mQuery(response.leads);mQuery('.shuffle-grid').prepend(items);mQuery('.shuffle-grid').shuffle('appended',items);mQuery('.shuffle-grid').shuffle('update');mQuery('#liveModeButton').data('max-id',response.maxId);}}
if(typeof IdleTimer!='undefined'&&!IdleTimer.isIdle()){if(response.indexMode=='list'){mQuery('#leadTable tr.warning').each(function(){var that=this;setTimeout(function(){mQuery(that).removeClass('warning',1000)},5000);});}else{mQuery('.shuffle-grid .highlight').each(function(){var that=this;setTimeout(function(){mQuery(that).removeClass('highlight',1000,function(){mQuery(that).css('border-top-color',mQuery(that).data('color'));})},5000);});}}
if(response.maxId){mQuery('#liveModeButton').data('max-id',response.maxId);}
Mautic.moderatedIntervalCallbackIsComplete('leadListLiveUpdate');},error:function(request,textStatus,errorThrown){Mautic.processAjaxError(request,textStatus,errorThrown);Mautic.moderatedIntervalCallbackIsComplete('leadListLiveUpdate');}});};Mautic.toggleAnonymousLeads=function(){var searchValue=mQuery('#list-search').typeahead('val');var string=mQuery('#anonymousLeadButton').data('anonymous').toLowerCase();if(searchValue.toLowerCase().indexOf('!'+string)==0){searchValue=searchValue.replace('!'+string,string);mQuery('#anonymousLeadButton').addClass('btn-primary');}else if(searchValue.toLowerCase().indexOf(string)==-1){if(searchValue){searchValue=searchValue+' '+string;}else{searchValue=string;}
mQuery('#anonymousLeadButton').addClass('btn-primary');}else{searchValue=mQuery.trim(searchValue.replace(string,''));mQuery('#anonymousLeadButton').removeClass('btn-primary');}
searchValue=searchValue.replace("  "," ");Mautic.setSearchFilter(null,'list-search',searchValue);};Mautic.getLeadEmailContent=function(el){Mautic.activateLabelLoadingIndicator('lead_quickemail_templates');mQuery('#MauticSharedModal .btn-primary').prop('disabled',true);Mautic.ajaxActionRequest('lead:getEmailTemplate',{'template':mQuery(el).val()},function(response){mQuery('#MauticSharedModal .btn-primary').prop('disabled',false);CKEDITOR.instances['lead_quickemail_body'].setData(response.body);mQuery('#lead_quickemail_subject').val(response.subject);Mautic.removeLabelLoadingIndicator();});};Mautic.updateLeadTags=function(){Mautic.activateLabelLoadingIndicator('lead_tags_tags');var formData=mQuery('form[name="lead_tags"]').serialize();Mautic.ajaxActionRequest('lead:updateLeadTags',formData,function(response){if(response.tags){mQuery('#lead_tags_tags').html(response.tags);mQuery('#lead_tags_tags').trigger('chosen:updated');}
Mautic.removeLabelLoadingIndicator();});};Mautic.createLeadTag=function(el){var newFound=false;mQuery('#'+mQuery(el).attr('id')+' :selected').each(function(i,selected){if(!mQuery.isNumeric(mQuery(selected).val())){newFound=true;}});if(!newFound){return;}
Mautic.activateLabelLoadingIndicator(mQuery(el).attr('id'));var tags=JSON.stringify(mQuery(el).val());Mautic.ajaxActionRequest('lead:addLeadTags',{tags:tags},function(response){if(response.tags){mQuery('#'+mQuery(el).attr('id')).html(response.tags);mQuery('#'+mQuery(el).attr('id')).trigger('chosen:updated');}
Mautic.removeLabelLoadingIndicator();});};Mautic.leadBatchSubmit=function(){if(Mautic.batchActionPrecheck()){if(mQuery('#lead_batch_remove').val()||mQuery('#lead_batch_add').val()||mQuery('#lead_batch_dnc_reason').length){var ids=Mautic.getCheckedListIds(false,true);if(mQuery('#lead_batch_ids').length){mQuery('#lead_batch_ids').val(ids);}else if(mQuery('#lead_batch_dnc_reason').length){mQuery('#lead_batch_dnc_ids').val(ids);}
return true;}}
mQuery('#MauticSharedModal').modal('hide');return false;};Mautic.updateLeadFieldValues=function(field){Mautic.activateLabelLoadingIndicator('campaignevent_properties_field');field=mQuery(field);var fieldAlias=field.val();Mautic.ajaxActionRequest('lead:updateLeadFieldValues',{'alias':fieldAlias},function(response){if(typeof response.options!='undefined'){var valueField=mQuery('#campaignevent_properties_value');var valueFieldAttrs={'class':valueField.attr('class'),'id':valueField.attr('id'),'name':valueField.attr('name'),'autocomplete':valueField.attr('autocomplete'),'value':valueField.attr('value')};if(!mQuery.isEmptyObject(response.options)){var newValueField=mQuery('<select/>').attr('class',valueFieldAttrs['class']).attr('id',valueFieldAttrs['id']).attr('name',valueFieldAttrs['name']).attr('autocomplete',valueFieldAttrs['autocomplete']).attr('value',valueFieldAttrs['value']);mQuery.each(response.options,function(optionKey,optionVal){var option=mQuery("<option/>").attr('value',optionKey).text(optionVal);newValueField.append(option);});valueField.replaceWith(newValueField);}else{var newValueField=mQuery('<input/>').attr('type','text').attr('class',valueFieldAttrs['class']).attr('id',valueFieldAttrs['id']).attr('name',valueFieldAttrs['name']).attr('autocomplete',valueFieldAttrs['autocomplete']).attr('value',valueFieldAttrs['value']);valueField.replaceWith(newValueField);}}
Mautic.removeLabelLoadingIndicator();});};Mautic.toggleTimelineMoreVisiblity=function(el){if(mQuery(el).is(':visible')){mQuery(el).slideUp('fast');mQuery(el).next().text(mauticLang['showMore']);}else{mQuery(el).slideDown('fast');mQuery(el).next().text(mauticLang['hideMore']);}};;Mautic.pageOnLoad=function(container){if(mQuery(container+' #list-search').length){Mautic.activateSearchAutocomplete('list-search','page.page');}
if(mQuery(container+' .page-stat-charts').length){Mautic.renderPageViewsBarChart(container);Mautic.renderPageReturningVisitsPie();Mautic.renderPageTimePie();}
if(mQuery(container+' #page_template').length){Mautic.toggleBuilderButton(mQuery('#page_template').val()=='');}
if(mQuery(container+' form[name="page"]').length){mQuery("*[data-toggle='field-lookup']").each(function(index){var target=mQuery(this).attr('data-target');var field=mQuery(this).attr('id');var options=mQuery(this).attr('data-options');Mautic.activatePageFieldTypeahead(field,target,options);});}
if(mQuery(container+' select[name="page[redirectType]"]').length){Mautic.autoHideRedirectUrl(container);mQuery(container+' select[name="page[redirectType]"]').chosen().change(function(){Mautic.autoHideRedirectUrl(container);});}};Mautic.pageOnUnload=function(id){if(id==='#app-content'){delete Mautic.pageViewsBarChartObject;delete Mautic.pageReturningVisitsPie;delete Mautic.pageTimePie;}};Mautic.renderPageViewsBarChart=function(container){if(!mQuery('#page-views-chart').length){return;}
chartData=mQuery.parseJSON(mQuery('#page-views-chart-data').text());if(typeof chartData.labels==="undefined"){return;}
var ctx=document.getElementById("page-views-chart").getContext("2d");var options={scaleShowGridLines:false,barShowStroke:false,barValueSpacing:1,showScale:false,tooltipFontSize:10,tooltipCaretSize:0}
if(typeof Mautic.pageViewsBarChartObject==='undefined'){Mautic.pageViewsBarChartObject=new Chart(ctx).Bar(chartData,options);}};Mautic.renderPageReturningVisitsPie=function(){if(typeof Mautic.pageReturningVisitsPie==='object'){return;}
var graphData=mQuery.parseJSON(mQuery('#returning-data').text());var options={responsive:false,tooltipFontSize:10};graphData=Mautic.emulateNoDataForPieChart(graphData);var ctx=document.getElementById("returning-rate").getContext("2d");Mautic.pageReturningVisitsPie=new Chart(ctx).Pie(graphData,options);};Mautic.renderPageTimePie=function(){if(typeof Mautic.pageTimePie==='object'){return;}
var element=mQuery('#time-rate');var options={responsive:false,tooltipFontSize:10,tooltipTemplate:"<%if (label){%><%}%><%= value %>x <%=label%>"};var timesOnSiteData=mQuery.parseJSON(mQuery('#times-on-site-data').text());timesOnSiteData=Mautic.emulateNoDataForPieChart(timesOnSiteData);var ctx=document.getElementById("time-rate").getContext("2d");Mautic.pageTimePie=new Chart(ctx).Pie(timesOnSiteData,options);};Mautic.getPageAbTestWinnerForm=function(abKey){if(abKey&&mQuery(abKey).val()&&mQuery(abKey).closest('.form-group').hasClass('has-error')){mQuery(abKey).closest('.form-group').removeClass('has-error');if(mQuery(abKey).next().hasClass('help-block')){mQuery(abKey).next().remove();}}
Mautic.activateLabelLoadingIndicator('page_variantSettings_winnerCriteria');var pageId=mQuery('#page_sessionId').val();var query="action=page:getAbTestForm&abKey="+mQuery(abKey).val()+"&pageId="+pageId;mQuery.ajax({url:mauticAjaxUrl,type:"POST",data:query,dataType:"json",success:function(response){if(typeof response.html!='undefined'){if(mQuery('#page_variantSettings_properties').length){mQuery('#page_variantSettings_properties').replaceWith(response.html);}else{mQuery('#page_variantSettings').append(response.html);}
if(response.html!=''){Mautic.onPageLoad('#page_variantSettings_properties',response);}}
Mautic.removeLabelLoadingIndicator();},error:function(request,textStatus,errorThrown){Mautic.processAjaxError(request,textStatus,errorThrown);spinner.remove();},complete:function(){Mautic.removeLabelLoadingIndicator();}});};Mautic.activatePageFieldTypeahead=function(field,target,options){if(options){var keys=values=[];options=options.split('||');if(options.length==2){keys=options[1].split('|');values=options[0].split('|');}else{values=options[0].split('|');}
var fieldTypeahead=Mautic.activateTypeahead('#'+field,{dataOptions:values,dataOptionKeys:keys,minLength:0});}else{var fieldTypeahead=Mautic.activateTypeahead('#'+field,{prefetch:true,remote:true,action:"page:fieldList&field="+target});}
mQuery(fieldTypeahead).on('typeahead:selected',function(event,datum){if(mQuery("#"+field).length&&datum["value"]){mQuery("#"+field).val(datum["value"]);}}).on('typeahead:autocompleted',function(event,datum){if(mQuery("#"+field).length&&datum["value"]){mQuery("#"+field).val(datum["value"]);}});};Mautic.autoHideRedirectUrl=function(container){var select=mQuery(container+' select[name="page[redirectType]"]');var input=mQuery(container+' input[name="page[redirectUrl]"]');if(select.val()==''){input.closest('.form-group').hide();input.val('');}else{input.closest('.form-group').show();}};;Mautic.initiateIntegrationAuthorization=function(){mQuery('#integration_details_in_auth').val(1);Mautic.postForm(mQuery('form[name="integration_details"]'),'loadIntegrationAuthWindow');};Mautic.loadIntegrationAuthWindow=function(response){if(response.newContent){response.target='#IntegrationEditModal .modal-body-content';Mautic.processPageContent(response);}else{Mautic.stopPageLoadingBar();Mautic.stopIconSpinPostEvent();mQuery('#integration_details_in_auth').val(0);if(response.authUrl){var generator=window.open(response.authUrl,'integrationauth','height=500,width=500');if(!generator||generator.closed||typeof generator.closed=='undefined'){alert(response.popupBlockerMessage);}}}};Mautic.refreshIntegrationForm=function(){var opener=window.opener;if(opener){var form=opener.mQuery('form[name="integration_details"]');if(form.length){var action=form.attr('action');if(action){opener.Mautic.startModalLoadingBar('#IntegrationEditModal');opener.Mautic.loadAjaxModal('#IntegrationEditModal',action);}}}
window.close()};Mautic.integrationOnLoad=function(container,response){if(response&&response.name){var integration='.integration-'+response.name;if(response.enabled){mQuery(integration).removeClass('integration-disabled');}else{mQuery(integration).addClass('integration-disabled');}}else{Mautic.filterIntegrations();}};Mautic.filterIntegrations=function(update){var filter=mQuery('#integrationFilter').val();if(update){mQuery.ajax({url:mauticAjaxUrl,type:"POST",data:"action=plugin:setIntegrationFilter&plugin="+filter});}
if(mQuery('.shuffle-integrations').length){var grid=mQuery(".shuffle-integrations");setTimeout(function(){grid.shuffle('shuffle',function($el,shuffle){if(filter){return $el.hasClass('plugin'+filter);}else{return true;}});mQuery("html").on("fa.sidebar.minimize",function(){grid.shuffle("update");}).on("fa.sidebar.maximize",function(){grid.shuffle("update");});},500);}};Mautic.getIntegrationLeadFields=function(integration,el,settings){Mautic.activateLabelLoadingIndicator(mQuery(el).attr('id'));if(typeof settings=='undefined'){settings={};}
var data={integration:integration,settings:settings};mQuery('#leadFieldsContainer').html('');Mautic.ajaxActionRequest('plugin:getIntegrationLeadFields',data,function(response){if(response.success){mQuery('#leadFieldsContainer').replaceWith(response.html);Mautic.onPageLoad('#leadFieldsContainer');if(mQuery('#fields-tab').length){mQuery('#fields-tab').removeClass('hide');}}else{if(mQuery('#fields-tab').length){mQuery('#fields-tab').addClass('hide');}}
Mautic.removeLabelLoadingIndicator();});};Mautic.getIntegrationConfig=function(el,settings){Mautic.activateLabelLoadingIndicator(mQuery(el).attr('id'));if(typeof settings=='undefined'){settings={};}
settings.name=mQuery(el).attr('name');var data={integration:mQuery(el).val(),settings:settings};mQuery('.integration-config-container').html('');Mautic.ajaxActionRequest('plugin:getIntegrationConfig',data,function(response){if(response.success){mQuery('.integration-config-container').html(response.html);Mautic.onPageLoad('.integration-config-container');}
Mautic.removeLabelLoadingIndicator();});};;Mautic.pointOnLoad=function(container){if(mQuery(container+' #list-search').length){Mautic.activateSearchAutocomplete('list-search','point');}};Mautic.pointTriggerOnLoad=function(container){if(mQuery(container+' #list-search').length){Mautic.activateSearchAutocomplete('list-search','point.trigger');}
if(mQuery('#triggerEvents')){mQuery('#triggerEvents').sortable({items:'.trigger-event-row',handle:'.reorder-handle',stop:function(i){mQuery.ajax({type:"POST",url:mauticAjaxUrl+"?action=point:reorderTriggerEvents",data:mQuery('#triggerEvents').sortable("serialize")+"&triggerId="+mQuery('#pointtrigger_sessionId').val()});}});mQuery('#triggerEvents .trigger-event-row').on('mouseover.triggerevents',function(){mQuery(this).find('.form-buttons').removeClass('hide');}).on('mouseout.triggerevents',function(){mQuery(this).find('.form-buttons').addClass('hide');}).on('dblclick.triggerevents',function(event){event.preventDefault();mQuery(this).find('.btn-edit').first().click();});}};Mautic.pointTriggerEventOnLoad=function(container,response){if(response.eventHtml){var newHtml=response.eventHtml;var eventId='#triggerEvent_'+response.eventId;if(mQuery(eventId).length){mQuery(eventId).replaceWith(newHtml);var newField=false;}else{mQuery(newHtml).appendTo('#triggerEvents');var newField=true;}
mQuery(eventId+" *[data-toggle='tooltip']").tooltip({html:true});mQuery(eventId+" a[data-toggle='ajax']").click(function(event){event.preventDefault();return Mautic.ajaxifyLink(this,event);});mQuery(eventId+" a[data-toggle='ajaxmodal']").on('click.ajaxmodal',function(event){event.preventDefault();Mautic.ajaxifyModal(this,event);});mQuery('#triggerEvents .trigger-event-row').off(".triggerevents");mQuery('#triggerEvents .trigger-event-row').on('mouseover.triggerevents',function(){mQuery(this).find('.form-buttons').removeClass('hide');}).on('mouseout.triggerevents',function(){mQuery(this).find('.form-buttons').addClass('hide');}).on('dblclick.triggerevents',function(event){event.preventDefault();mQuery(this).find('.btn-edit').first().click();});if(!mQuery('#events-panel').hasClass('in')){mQuery('a[href="#events-panel"]').trigger('click');}
if(mQuery('#triggerEventPlaceholder').length){mQuery('#triggerEventPlaceholder').remove();}}};Mautic.getPointActionPropertiesForm=function(actionType){Mautic.activateLabelLoadingIndicator('point_type');var query="action=point:getActionForm&actionType="+actionType;mQuery.ajax({url:mauticAjaxUrl,type:"POST",data:query,dataType:"json",success:function(response){if(typeof response.html!='undefined'){mQuery('#pointActionProperties').html(response.html);Mautic.onPageLoad('#pointActionProperties',response);}},error:function(request,textStatus,errorThrown){Mautic.processAjaxError(request,textStatus,errorThrown);},complete:function(){Mautic.removeLabelLoadingIndicator();}});};;Mautic.reportOnLoad=function(container){if(mQuery(container+' #list-search').length){Mautic.activateSearchAutocomplete('list-search','report');}
if(mQuery('div[id=report_filters]').length){mQuery('div[id=report_filters]').data('index',mQuery('#report_filters > div').length);mQuery('div[id=report_tableOrder]').data('index',mQuery('#report_tableOrder > div').length);if(mQuery('.filter-columns').length){mQuery('.filter-columns').each(function(){Mautic.updateReportFilterValueInput(this,true);});}}
Mautic.initReportGraphs();};Mautic.reportOnUnload=function(id){if(id==='#app-content'){delete Mautic.reportGraphs;}};Mautic.addReportRow=function(elId){var prototypeHolder=mQuery('div[id="'+elId+'"]');var index=prototypeHolder.data('index');var prototype=prototypeHolder.data('prototype');var output=prototype.replace(/__name__/g,index);prototypeHolder.data('index',index+1);prototypeHolder.append(output);var newColumnId='#'+elId+'_'+index+'_column';if(typeof Mautic.reportPrototypeColumnOptions!='undefined'){mQuery(newColumnId).html(Mautic.reportPrototypeColumnOptions);}
if(elId=='report_filters'){mQuery(newColumnId).on('change',function(){Mautic.updateReportFilterValueInput(this);});Mautic.updateReportFilterValueInput(newColumnId);}
Mautic.activateChosenSelect(mQuery('#'+elId+'_'+index+'_column'));mQuery("#"+elId+" *[data-toggle='tooltip']").tooltip({html:true,container:'body'});};Mautic.updateReportFilterValueInput=function(filterColumn,setup){var types=(typeof Mautic.reportPrototypeColumnTypes!='undefined')?Mautic.reportPrototypeColumnTypes:mQuery('#report_filters').data('column-types');var newValue=mQuery(filterColumn).val();var filterId=mQuery(filterColumn).attr('id');var filterType=types[newValue];var valueEl=mQuery(filterColumn).parent().parent().find('.filter-value');var valueVal=valueEl.val();var idParts=filterId.split("_");var valueId='report_filters_'+idParts[2]+'_value';var valueName='report[filters]['+idParts[2]+'][value]';if(filterType=='bool'){if(mQuery(valueEl).attr('type')!='radio'){var template=mQuery('#filterValueYesNoTemplate .btn-group').clone(true);mQuery(template).find('input[type="radio"]').each(function(){mQuery(this).attr('name',valueName);var radioVal=mQuery(this).val();mQuery(this).attr('id',valueId+'_'+radioVal);});mQuery(valueEl).replaceWith(template);}
if(setup){mQuery('#'+valueId+'_'+valueVal).click();}}else if(mQuery(valueEl).attr('type')!='text'){var newValueEl=mQuery('<input type="text" />').attr({id:valueId,name:valueName,'class':"form-control filter-value"});var replaceMe=(mQuery(valueEl).attr('type')=='radio')?mQuery(valueEl).parent().parent():mQuery(valueEl);replaceMe.replaceWith(newValueEl);}
if(filterType=='datetime'||filterType=='date'||filterType=='time'){Mautic.activateDateTimeInputs('#'+valueId,filterType);}else if(mQuery('#'+valueId).hasClass('calendar-activated')){mQuery('#'+valueId).datetimepicker('destroy');}};Mautic.removeReportRow=function(container){mQuery("#"+container+" *[data-toggle='tooltip']").tooltip('destroy');mQuery('#'+container).remove();};Mautic.updateReportSourceData=function(context){Mautic.activateLabelLoadingIndicator('report_source');mQuery.ajax({url:mauticAjaxUrl,type:'post',data:"action=report:getSourceData&context="+context,success:function(response){mQuery('#report_columns').html(response.columns);mQuery('#report_columns').multiSelect('refresh');mQuery('#report_filters').find('div').remove().end();mQuery('#report_filters').data('index',0);Mautic.reportPrototypeColumnTypes=response.types;mQuery('#report_tableOrder').find('div').remove().end();mQuery('#report_tableOrder').data('index',0);Mautic.reportPrototypeColumnOptions=mQuery(response.columns);mQuery('#report_graphs').html(response.graphs);mQuery('#report_graphs').multiSelect('refresh');if(!response.graphs){mQuery('#graphs-container').addClass('hide');mQuery('#graphs-tab').addClass('hide');}else{mQuery('#graphs-container').removeClass('hide');mQuery('#graphs-tab').removeClass('hide');}},error:function(request,textStatus,errorThrown){Mautic.processAjaxError(request,textStatus,errorThrown);},complete:function(){Mautic.removeLabelLoadingIndicator();}});};Mautic.checkReportCondition=function(selector){var option=mQuery('#'+selector+' option:selected').val();var valueInput=selector.replace('condition','value');if(option=='empty'||option=='notEmpty'){mQuery('#'+valueInput).prop('disabled',true);}else{mQuery('#'+valueInput).prop('disabled',false);}};Mautic.initReportGraphs=function(){Mautic.reportGraphs={};var graphs=mQuery('canvas.graph');mQuery.each(graphs,function(i,graph){var mGraph=mQuery(graph);if(mGraph.hasClass('graph-line')){var id=mGraph.attr('id');if(typeof Mautic.reportGraphs[id]==='undefined'){var graphData=mQuery.parseJSON(mQuery('#'+id+'-data').text());Mautic.reportGraphs[id]=Mautic.renderReportLineGraph(graph.getContext("2d"),graphData);}}
if(mGraph.hasClass('graph-pie')){var id=mGraph.attr('id');if(typeof Mautic.reportGraphs[id]==='undefined'){var graphData=mQuery.parseJSON(mQuery('#'+id+'-data').text());Mautic.reportGraphs[id]=Mautic.renderReportPieGraph(graph.getContext("2d"),graphData);}}});}
Mautic.updateReportGraph=function(element,amount,unit){var canvas=mQuery(element).closest('.panel').find('canvas');var id=canvas.attr('id');var reportId=Mautic.getEntityId();var options={'graphName':id.replace(/\-/g,'.'),'amount':amount,'unit':unit};var query='reportId='+reportId+'&'+mQuery.param(options);var callback=function(response){Mautic.reportGraphs[id].destroy();delete Mautic.reportGraphs[id];if(typeof response.graph.datasets!='undefined'){Mautic.reportGraphs[id]=Mautic.renderReportLineGraph(canvas.get(0).getContext("2d"),response.graph);}};Mautic.getChartData(element,'report:updateGraph',query,callback);}
Mautic.renderReportLineGraph=function(canvas,chartData){var options={};return new Chart(canvas).Line(chartData,options);};Mautic.renderReportPieGraph=function(canvas,chartData){var options={responsive:false,tooltipFontSize:10,tooltipTemplate:"<%if (label){%><%}%><%= value %>x <%=label%>"};Mautic.pageTimePie=new Chart(canvas).Pie(chartData,options);};Mautic.userOnLoad=function(container){if(mQuery(container+' form[name="user"]').length){if(mQuery('#user_position').length){Mautic.activateTypeahead('#user_position',{displayKey:'position'});}}else{if(mQuery(container+' #list-search').length){Mautic.activateSearchAutocomplete('list-search','user.user');}}};Mautic.roleOnLoad=function(container,response){if(mQuery(container+' #list-search').length){Mautic.activateSearchAutocomplete('list-search','user.role');}
if(response&&response.permissionList){MauticVars.permissionList=response.permissionList;}};Mautic.togglePermissionVisibility=function(){setTimeout(function(){if(mQuery('#role_isAdmin_0').prop('checked')){mQuery('#rolePermissions').removeClass('hide');mQuery('#isAdminMessage').addClass('hide');}else{mQuery('#rolePermissions').addClass('hide');mQuery('#isAdminMessage').removeClass('hide');}},10);};Mautic.onPermissionChange=function(changedPermission,bundle){var granted=0;if(mQuery(changedPermission).prop('checked')){if(mQuery(changedPermission).val()=='full'){mQuery(changedPermission).closest('.choice-wrapper').find("label input:checkbox:checked").map(function(){if(mQuery(this).val()!='full'){mQuery(this).prop('checked',false);mQuery(this).parent().toggleClass('active');}})}else{mQuery(changedPermission).closest('.choice-wrapper').find("label input:checkbox:checked").map(function(){if(mQuery(this).val()=='full'){granted=granted-1;mQuery(this).prop('checked',false);mQuery(this).parent().toggleClass('active');}})}}
if(mQuery('.'+bundle+'_granted').length){var granted=0;var levelPerms=MauticVars.permissionList[bundle];mQuery.each(levelPerms,function(level,perms){mQuery.each(perms,function(index,perm){var isChecked=mQuery('input[data-permission="'+bundle+':'+level+':'+perm+'"]').prop('checked');if(perm=='full'){if(isChecked){if(perms.length===1){granted++;}else{granted+=perms.length-1;}}}else if(isChecked){granted++;}});});mQuery('.'+bundle+'_granted').html(granted);}};;Mautic.sendHookTest=function(){var url=mQuery('#webhook_webhook_url').val();var eventTypes=mQuery("#event-types input[type='checkbox']");var selectedTypes=[];eventTypes.each(function(){var item=mQuery(this);if(item.is(':checked')){selectedTypes.push(item.val());}});var data={action:'webhook:sendHookTest',url:url,types:selectedTypes};var spinner=mQuery('#spinner');spinner.removeClass('hide');mQuery.ajax({url:mauticAjaxUrl,data:data,type:'POST',dataType:"json",success:function(response){if(response.success){mQuery('#tester').html(response.html);}},error:function(request,textStatus,errorThrown){Mautic.processAjaxError(request,textStatus,errorThrown);},complete:function(response){spinner.addClass('hide');}})};